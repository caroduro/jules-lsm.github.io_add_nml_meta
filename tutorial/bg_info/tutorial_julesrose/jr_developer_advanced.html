<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
        <meta name="description" content="JULES-Rose Tutorial" />
        <meta name="author" content="JULES System Manager" />
        <link rel="icon" href="jules_logo.png" />
        <title>JULES-Rose developer advanced</title>
        <!-- Bootstrap core CSS -->
        <link href="../etc/bootstrap/css/bootstrap.min.css" rel="stylesheet" />
        <!-- Bootstrap theme -->
        <link href="../etc/bootstrap/css/bootstrap-theme.min.css" rel="stylesheet" />
        <!-- Custom styles for this template -->
        <link href="general_theme.css" rel="stylesheet" />
</head>
    <body>
        <!-- Fixed navbar -->
        <nav class="navbar navbar-inverse navbar-fixed-top">
            <div class="container">
                <div class="navbar-header">
                    <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    </button>
                    <a class="navbar-brand" href="#">JULES Developer Advanced</a>
                </div>
                <div id="navbar" class="navbar-collapse collapse">
                    <ul class="nav navbar-nav">
                        <!-- Add link to Homepage to training when created -->
                        <li class="active"><a href="#">Home</a></li>
                        <li class="dropdown">
                            <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">Developer Advanced material <span class="caret"></span></a>
                            <ul class="dropdown-menu">
                                <li class="dropdown-header">Developer Advanced Tutorials</li>
                                <li><a href="#umdp3">UMDP3</a></li>
                                <li role="separator" class="divider"></li>
                                <li class="dropdown-header">Developer Advanced Practical's</li>
                                <li><a href="#arst">Adding rose stem tests</a></li>
                                 <li><a href="#aum">Adding a complex upgrade macro</a></li>
                                <li><a href="#umjt">UM-JULES tickets</a></li>
                                <li><a href="#rfcmc">Resolving FCM conflicts</a></li>
                            </ul>
                        <li class="dropdown">
                            <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">Other material <span class="caret"></span></a>
                            <ul class="dropdown-menu">
                                <li class="dropdown-header">Quizzes</li>
                                <li><a href="precourse_quiz.html">Pre-course Quiz</a></li>
                                <li><a href="user_quiz.html">User Quiz</a></li>

                                <li><a href="developer_quiz.html">Developer Quiz</a></li>
                                <li><a href="developer advanced_quiz.html">Developer Advanced Quiz</a></li>
                                <li role="separator" class="divider"></li>
                                <li class="dropdown-header">Tutorials and practical's</li>
                                <li><a href="jr_user.html">User</a></li>
                                <li><a href="jr_developer.html">Developer</a></li>
                                <li role="separator" class="divider"></li>
                                <li class="dropdown-header">Help/info</li>
                                <li><a href="jr_glossary.html">Glossary List</a></li>
                                <li><a href="jr_links.html">Links</a></li>
                                <li><a href="jr_mqrg.html">My Quick Reference Guide</a></li>
                                <li><a href="jr_structures.html">JULES structures</a></li>
                                <li><a href="jr_rosecylc_setup.html">Rose/Cylc set-up</a></li>
                            </ul>
                        </li>
                    </ul>
                </div>
                <!--/.nav-collapse -->
            </div>
        </nav>
        <div class="container theme-showcase" role="main">
        <div class="jumbotron">
            <h1>Developer Advanced JULES-Rose tutorial (in development)</h1>
            <p>This aims to explain the importance of:
            <ul>
                <li><a href="#umdp3">UMDP3</a></li>
                <li><a href="#arst">Adding rose stem tests</a></li>
                <li><a href="#aum">Adding a complex upgrade macro</a></li>
                <li><a href="#umjt">UM-JULES tickets</a></li>
                <li><a href="#rfcmc">Resolving FCM conflicts</a></li>

            </ul>
            </p>
        </div>

        <div class="well">
            <p>It is expected that you have:
            <ul>
            <li>Completed the <a href="http://metomi.github.io/rose/doc/rose.html">Rose User Guide</a>.</li>
            <li>Completed the <a href="jr_user.html">User Tutorial</a>.</li>
            <li>Completed the <a href="user_quiz.html">User Quiz</a>.</li>
            <li>Completed the <a href="jr_developer.html">Developer Tutorial</a>.</li>
            <li>Completed the <a href="developer_quiz.html">Developer Quiz</a>.</li>
            </ul>
            </p>
            <p>
            OR have:
            <ul>
            <li>Experience running rose stem and JULES-Rose suites.</li>
            <li>Made complex changes to JULES-Rose suites.</li>
            <li>Made complex changes to JULES code including testing with rose stem.</li>
            <li>Experience with FCM commands.</li>
            </ul>
            </p>
        </div>

        <br/>


        <h2><a id="umdp3">UMDP3</a></h2>
        <p>
        <ul>
            <div class="page-header">
                <h3>In development. Coming soon.</h3>
            </div>
            <div class="well">
               <p>The UM Systems team provide detailed guidance on software
                  standards, which can be found in their <a href="https://code.metoffice.gov.uk/doc/um/latest/papers/umdp_003.pdf">UMDP3</a> pdf.</p>


            </div>
        </ul>
        </p>

        <h2><a id="arst">Adding rose stem tests</a></h2>
        <p>
        <ul>
            <div class="page-header">
                <h3>Overview</h3>
            </div>
            <div class="well">
               <p>The suite in <code>rose-stem</code> is a regression testing suite.
                  It is used to verify that science/code changes do not break
                  existing science/code within the JULES (with any new science 
                  switched off).
                  It does this by checking that the results of the modified 
                  code and comparing them with Known Good Output (KGO)
                  which is produced from the trunk of the JULES code.
             </p>
             <p>It is occasionally acceptable tests to fail and therefore for
                results not to compare exactly with the KGO.
                generally changes are very small and well understood and reasoned.
                It is acceptable when:
              <ul>
              <li>The cause of the differences is well understood, for example,                   bug fix, initialisation error, improvement to science.
                  These are at the discretion of the reviewers.</li>
              <li>New tests.</li>
              </ul>
              </p>
             <p>Rose stem app should never be changed other than by applying
                the <code>upgrade_jules_test_apps</code> script.
                The <code>upgrade_jules_test_apps</code> script runs the 
                upgrade macro which should only modify the namelists enough 
                for rose stem tasks to pass.</p>
            </div>
            <div class="page-header">
                <h3>Rose stem tests</h3>
            </div>
            <div class="well">
            <p>Once you have identified the rose stem test that you want to 
               create to safe guard a science configuration then please try to
               develop the test.</p>
            <p>A good starting point it to see if there is already and exisiting
               rose stem test that is similar and then use that to tweek for
               the desired configuration.</p>
            <p>Rose stem test names should be as descriptive as possible while
               still being reasonably short.
               For example: gswp2_irrig_limit_low_river_storage .</p>
            <p>This rose stem test was developed to test:  
               Rose stem test with irrigation supply limited.
               Starting with no water in the rivers and lots in the deep layer, therefore irrigation water should be mainly taken from the deep layer.</p>
            <p>Change, <code>rose-stem/include/</code>: <code>meto</code>,
               <code>vm</code>, <code>jasmin</code>, <code>ceh</code>,
               <code>niwa</code> etc. <code>runtime*.rc</code> and 
               <code>graph*.rc</code> files.</p>
           <p><code>runtime*.rc</code> should include tasks <code>[[ ]]</code>
              for the jules run (gswp2_irrig_limit_low_river_storage), KGO compare (nccmp_gswp2_irrig_limit_low_river_storage), housekeeping task (housekeep_gswp2_irrig_limit_low_river_storage).</p>
           <p><code>graph*.rc</code> should include graph dependancies, for example:
<pre>
 "gswp2_irrig_limit_low_river_storage" : "fcm_make_mpi =&gt; \
   gswp2_trip_spinup =&gt; gswp2_irrig_limit_low_river_storage =&gt; \
    nccmp_gswp2_irrig_limit_low_river_storage =&gt; housekeep_gswp2_trip_spinup =&gt; \
       housekeep_gswp2_irrig_limit_low_river_storage", 
</pre>
<p>and add it to the corect groups:
<pre>
 "gswp2" : ["gswp2_rivers", "gswp2_trip", "gswp2_trip_restart", "gswp2_irrig_limit_low_river_storage",...]
</pre>
           </p>
           <p>Add you new rose-app.conf, e.g. <code>
rose-stem/app/gswp2_irrig_limit_low_river_storage/rose-app.conf</code>
             Don't forget to 
<pre>fcm add rose-stem/app/gswp2_irrig_limit_low_river_storage/rose-app.conf </pre>
           your new file with its directory structure.</p>
            </div>


            <div class="page-header">
                <h3>Testing new rose stem tests</h3>
            </div>
            <div class="well">
            <p>Before you test your new rose stem tests please run:</p> 
<pre>
rose macro --fix -M /path/to/JULES/metadata/dir/
and OR
/path/to/JULES/metadata/dir/bin/upgrade_jules_test_apps vnX.X_t&lt;ticket_num&gt;
</pre>
             <p>Where the <code>vnX.X_tt&lt;ticket_num&gt;</code> is given in
              the file <code>rose-meta/jules-standalone/versions.py</code>. </p>
            </div>
            <div class="page-header">
                <h3>Creating KGO</h3>
            </div>
            <div class="well">
            <p>If you are using the JULES VM, you will need to generate the 
               appropriate KGO for testing.
               This is done using the trunk at the version from which your
               branch is taken:</p>
<pre>
fcm co fcm:jules.x_tr@<version> jules_trunk
cd jules_trunk
</pre>
           <p>KGO generation is done by using the rose-stem system to generate
              the output and then moving it to the KGO directory.
              The KGO version can be found by looking at
              <code>rose-stem/include/variables.rc</code> file.
             </p>
<pre>
# Using HOUSEKEEPING=false means the output is not deleted when it is finished with
rose stem --group=all --source=. -S HOUSEKEEPING=false --new

# Move the output to the KGO directory
mkdir -p /jules/rose-stem-kgo/&lt;KGO version&gt;
mv ~/cylc-run/jules_trunk/work/1/*/output/* /jules/rose-stem-kgo/&lt;KGO version&gt;
</pre>
            </div>
           <div class="page-header">
                <h3>Testing local KGO</h3>
            </div>
            <div class="well">
            <p>As part of your rose stem test you may expect the KGO to fail 
               for example you have created new rose stem tests so no previous
                rose stem test KGO exists yet.</p>
            <p>You may wish to test your new local test KGO, but it is not
               compulsory.</p>
            <p>First, commit your changes to your branch of the repository.</p>
<pre>
rose stem --group=all --new -S HOUSEKEEPING=false
</pre>
            <p>The suite will stop with waiting and have failures, this is 
               as expected.</p>
            <p>Now we need to copy the `local test` KGO to a directory for testing.</p>
<pre>
JULES_VERSION=vn#.#
TICKET_NUMBER=t###
TEST_KGO_DIR=~$USERNAME/jules/rose-test-kgo/${JULES_VERSION}_${TICKET_NUMBER}
mkdir -p ${TEST_KGO_DIR}
</pre>
          <p>then edit KGO_DIR in the appropriate files:<br/>
          For example at the Met Office:</p>
<pre>
/include/meto/runtime-xc40-cce.rc       
/include/meto/runtime-linux.rc
</pre>
              <p>at JASMIN</p>
<pre>
/include/jasmin/runtime.rc
</pre>
             <p>to point to the new location.</p>
             <p>Copy the <code>local test</code> KGO to the new directories.
                The new test files will be in ~/cylc-run/&lt;suitename&gt;/work/1/*/output/*</p>
              <p>Now stop the suite using the cylc gcycl GUI or</p>
<pre>
rose suite-shutdown --name=&lt;SUITE_NAME&gt; -- --now
y
</pre>
             <p>Run rose stem on this branch</p>
<pre>rose stem --group=all --new</pre>
             <p>If the tests are bit reproducible they will all pass this time and if not then this needs to be addressed.</p>
             <p>All changes to the local copy will need to be reverted, you can use:</p>
<pre>
fcm st
fcm revert &lt;FILENAMES&gt;
fcm st
</pre>
              <p>Note new KGO will be added to the central directories by the System Administrator at or just after the code is committed to the trunk.</p>
            
            </div>

        </ul>
        </p>

        <h2><a id="aum">Adding a complex upgrade macro</a></h2>
        <p>
        <ul>
            <div class="page-header">
                <h3>Values in a namelist are consolidated</h3>
            </div>
            <div class="well">
               <p>This example shows an addition to the <code>rose-meta/jules-standalone/versions.py</code>
                  file to use only rfm and trip and point um_rfm and um_trip to
                  to the respective river values.
                 </p>
<pre>
class vn47_t417(rose.upgrade.MacroUpgrade):

    """Upgrade macro from JULES by Kerry Smout-Day"""

    BEFORE_TAG = "vn4.7_t413"
    AFTER_TAG = "vn4.7_t417"

    def upgrade(self, config, meta_config=None):
        """Upgrade a JULES runtime app configuration.
           Point um_trip to trip, um_rfm to rfm as the values have been removed.
           """

         river_value = self.get_setting_value(config, ["namelist:jules_rivers", "rivers_type"])
         if river_value == "'um_trip'":
             self.change_setting_value(config, ["namelist:jules_rivers", "rivers_type"], 'trip')
             trip_msg= """
             !!!!! NOTE: um_trip is now replaced by trip see jls #417    !!!!
                  """
             self.add_report(info=trip_msg, is_warning=True)
         elif river_value == "'um_rfm'":
             self.change_setting_value(config, ["namelist:jules_rivers", "rivers_type"], 'rfm')
             rfm_msg= """
             !!!!! NOTE: um_rfm is now replaced by rfm see jls #417      !!!!
                  """
             self.add_report(info=rfm_msg, is_warning=True)
        return config, self.reports
</pre>
            </div>
            <div class="page-header">
                <h3>HEREHER</h3>
            </div>
            <div class="well">
               <p>HEREHER
               </p>
<pre>
class vn45_t256(rose.upgrade.MacroUpgrade):

    """Upgrade macro from JULES by Firstname Surname"""

    BEFORE_TAG = "vnX.X_tXXX"
    AFTER_TAG = "vnX.X_tXXX"

    def upgrade(self, config, meta_config=None):
        """Upgrade a JULES runtime app configuration."""

        npft = int(self.get_setting_value(config, ["namelist:jules_surface_types", "npft"]))
        self.add_setting(config, ["namelist:jules_pftparm", "can_struct_a_io"],','.join(['1.0']*npft))

        return config, self.reports
</pre>
            </div>
        </ul>
        </p>


        <h2><a id="umjt">UM-JULES tickets</a></h2>
        <p>
        <ul>
            <div class="page-header">
                <h3>Testing JULES with the UM code</h3>
            </div>
            <div class="well">
               <p> This section assumes that your JULES changes do not have 
                   linked UM changes.</p>
<pre>
# check that there are no uncommitted changes for your branch.
cd /path/to/JULES/branch_for_testing/
fcm st
# should return nothing.
cd /to/directory/for/checking/out/UMtrunk/into/
fcm co fcm:um.x_tr
cd trunk
rose stem --group=jules --new --name=umtr_jlst### --source=. --source=/path/tp/jules/branch_for_testing
# trac.log will appear in the cylc-run/umtr_jlst### when the rose stem tests have finished.
</pre>
            <p>If the UM rose-stem tests fail, it may be because your changes
               require UM meta-data changes and/or a UM upgrade macro.
               In this case, you will need to create a UM branch, following 
               the <a href="https://code.metoffice.gov.uk/trac/um/wiki/working_practices">working_practices UM working practices</a>.
            </p>
            </div>
            <div class="page-header">
                <h3>Linked UM-JULES changes</h3>
            </div>
            <div class="well">
               <p>If you have linked UM changes, you should be following the
                   <a href="https://code.metoffice.gov.uk/trac/um/wiki/working_practices">working_practices UM working practices</a>.</p>

            </div>
        </ul>
        </p>

        <h2><a id="rfcmc">Resolving FCM conflicts</a></h2>
        <p>
        <ul>
            <div class="page-header">
                <h3>FCM Text and Tree conflicts.</h3>
            </div>
            <p>Sometimes when we merge branches into HoT branches we recieve a
               message at the end of the merge saying that we have 
               <code>Text Conflicts</code> or <code>Tree Conflicts</code>.
               <code>Text Conflicts</code> are easier to resolve than
                <code>Tree Conflicts</code> in general.</p>
            <div class="well">
            <h4>fcm conflicts</h4>
            <p>The command <code>fcm conflicts|cf</code> is a graphical tool to help
               resolve conflicts within the local/working copy.
               Note it cannot help with all conflicts.
               It works with the most effectively with Text Conflicts.
            </p>
            <p>A type of conflict that we may come across are "Text conflicts".
               These are returned via <code>fcm st</code> as
            </p>
            <pre>C    statusesC_text.txt </pre>
            <p>where column 1 has a "C" in it.
            </p>
            <p>To resolve the text conflict we use the 3-way difference tool xxdiff.
            </p>
            <p>For each file with a text conflict, the <code>fcm conflicts</code> command
               calls a graphical merge tool (i.e. xxdiff by default) to display a 3-way diff.
            </p>
            <h4>How to use xxdiff to help resolve text conflicts</h4>
            <p>The file on the left is our original file.
               The file in the middle is the common ancestor from the merge.
               The file on the right is the file containing the changes which we are merging
               in.
            </p>
            <p>The image below shows an image of a text conflict.</p> 
            <img src="images/text_conflict2.png" width="95%" id="fcm_cf">
           <p>Left click on the text option that we want to keep, it should change colour
           from yellow to purple.
                                 </p>
           <p>Then press "m", or use the toolbar; File -&gt; Exit with MERGED M.</p>
            <h4>Explanations of the three window split xxdiff:</h4>
            <p>The number on the far right panel of xxdiff tool is the number of unselected
               differences, known as "hunks" or "sections" and they are often seen in yellow.
               The correct term for the highlighted section is hunk, but here we will refer to
               it as the section as it is easier to understand and remember what we are talking about.
            </p>
            <p>When this number is 0 then we are ready to save the merged file.
            </p>
            <p>To see how the merged file will look with the current selections, click
               Windows-&gt;Toggle Merged View (keyboard shortcut: Alt+Y).
            </p>
            <p>An extra window then appears showing the merged output that updates
               interactively as we make our selections.
            </p>
            <p>
               If we just want to exit without making any decisions we can also just close
               the window.
            </p>
            <p>
               <a href="http://furius.ca/xxdiff/doc/xxdiff-doc.html">xxdiff documentation</a>
            </p>
            <p>
               If we have resolved all the conflicts in a file then we will be prompted on
               whether to run <code>svn resolved</code> on the file to signal that the file
               is no longer in conflict.
            </p>
         </div>
         <div class="well">
            <h4>fcm resolve</h4>
            <p>The <code>fcm resolve</code> command can be used to resolve conflicts in
               local/working copy files or directories.
                Mainly tree conflicts.
            </p>
            <p>A common way of using this command is:
            </p>
            <p><code>fcm resolve --accept working &lt;FILENAME&gt;</code>
            </p>
            <p>This will try to resolve the tree conflict and ask you if you 
               would like to go ahead with the merge? This is fo you to decide.</p>
            <p>
               A common way that a tree conflict occurs is after a merge when a file has been
               deleted or renamed on one branch, and modified on another.
               These are incompatible changes, therefore Subversion doesn't know which
               action to take.
               This is the cause of the tree conflict dilemma which the user must solve.
            </p>
            <p>Example: choose to keep the local version or not?</p>
<pre>
[info] tree_conflict.txt: in tree conflict.
Locally: deleted.
Externally: edited.
Answer (y) to accept the local delete.
Answer (n) to keep the file.
Keep the local version?
Enter "y" or "n" (or just press &lt;return&gt; for "n") y
Resolved conflicted state of 'tree_conflict.txt'
</pre>
            <p>In this example, to keep the file as it was before (in a deleted state), enter
               <samp>y</samp>.
            </p>
            <p>Otherwise, to accept the merge branch version of the file (adding it with the
               edited changes), enter <samp>n</samp>.
            </p>
            <br/>
            <p>See a tutorial on <a href="http://jules-lsm.github.io/tutorial/bg_info/tutorial/fcm_specifics.html#cf">FCM conflicts</a> for more details.</p>
            </div>
        </ul>
        </p>


            <br/>

            <h3>Congratulations you have completed the Developer Advanced Tutorial!</h3>
        <br/>
        <div class="container">
        <div class="well">
        Now lets do the Developer Advanced Quiz to highlight your learning.
        </div>
        <p><a class="btn btn-lg btn-success" href="Developer Advanced_quiz.html" role="button">Developer Advanced Quiz</a></p>
        </div>
        <br/>
        <br/>
        <div class="container">
        <div class="well">
        Now you have completed the tutorial, for any further questions please email <a href="mailto:Jules-Support@metoffice.gov.uk?Subject=JULES%20Tutorial%20Support">JULES Support</a>
        </div>
        </div>
        <br/>
        <div class="container">
        </div>
        <hr/>
        <div class="container-fluid text-center">
        <div class="row">
        <div class="col-md-12">
        <address><small>
        &copy; British Crown Copyright 2006-17
        <a href="http://www.metoffice.gov.uk">Met Office</a>.<br />
        This document is released under the British <a href=
            "http://www.nationalarchives.gov.uk/doc/open-government-licence/" rel=
            "license">Open Government Licence</a>.<br />
        </small>
        </address>
        </div>
        </div>
        </div>
        <!-- Bootstrap core JavaScript
            ================================================== -->
        <!-- Placed at the end of the document so the pages load faster -->
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
        <script>window.jQuery || document.write('<script src="./js/vendor/jquery.min.js"><\/script>')</script>
        <script src="../etc/bootstrap/js/bootstrap.min.js"></script>
        <script src="./js/docs.min.js"></script>
        <script LANGUAGE="JavaScript">
            update = new Date(document.lastModified);
            theMonth = update.getMonth() + 1;
            theDate = update.getDate();
            theYear = update.getFullYear();
            theHour = update.getHours();
            theMin = update.getMinutes();
            theSec = update.getSeconds();
            document.write("<strong> Last Modified:</strong> " + theYear + "-" + theMonth + "-" + theDate + "T" + theHour + ":" + theMin + ":" + theSec + "Z");
                
        </script>
        </div>
    </body>
</html>

