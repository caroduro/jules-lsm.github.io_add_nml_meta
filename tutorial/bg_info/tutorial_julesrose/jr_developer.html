<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
        <meta name="description" content="JULES-Rose Tutorial" />
        <meta name="author" content="JULES System Manager" />
        <link rel="icon" href="jules_logo.png" />
        <title>JULES-Rose developer</title>
        <!-- Bootstrap core CSS -->
        <link href="../etc/bootstrap/css/bootstrap.min.css" rel="stylesheet" />
        <!-- Bootstrap theme -->
        <link href="../etc/bootstrap/css/bootstrap-theme.min.css" rel="stylesheet" />
        <!-- Custom styles for this template -->
        <link href="general_theme.css" rel="stylesheet" />
</head>
    <body>
        <!-- Fixed navbar -->
        <nav class="navbar navbar-inverse navbar-fixed-top">
            <div class="container">
                <div class="navbar-header">
                    <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    </button>
                    <a class="navbar-brand" href="#">JULES Developer</a>
                </div>
                <div id="navbar" class="navbar-collapse collapse">
                    <ul class="nav navbar-nav">
                        <!-- Add link to Homepage to training when created -->
                        <li class="active"><a href="#">Home</a></li>
                        <li class="dropdown">
                            <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">Developer material <span class="caret"></span></a>
                            <ul class="dropdown-menu">
                                <li class="dropdown-header">Developer Tutorials</li>
                                <li><a href="#bjrstem">Basics of JULES rose stem</a></li>
                                <li><a href="#bcode">Basics of Coding -UMDP3, Reviewing</a></li>
                                <li><a href="#bjrsuite">Running a basic JULES-Rose suite</a></li>
                                <li role="separator" class="divider"></li>
                                <li class="dropdown-header">Developer Practical's</li>
                                <li><a href="#Pracs">Practical's</a></li>
                                <li><a href="#fjre">Further JULES Rose Edit</a></li>
                                <li><a href="#fjrsuite">Further JULES-Rose suites - duration, domain</a></li>
                                <li><a href="#fjrstem">Further JULES rose stem - namelists, modules</a></li>
                                <li><a href="#ticks">More on Tickets - Populating</a></li>
                                <li><a href="#hot">HoT branches and merging branch into it</a></li>
                                <li><a href="#umj">UM-JULES</a></li>
                                <li><a href="#md">Metadata</a></li>
                                <li><a href="#upmac">Upgrade macros</a></li>                            </ul>
                        <li class="dropdown">
                            <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">Other material <span class="caret"></span></a>
                            <ul class="dropdown-menu">
                                <li class="dropdown-header">Quizzes</li>
                                <li><a href="precourse_quiz.html">Pre-course Quiz</a></li>
                                <li><a href="user_quiz.html">User Quiz</a></li>

                                <li><a href="developer_quiz.html">Developer Quiz</a></li>
                                <li><a href="developer_advanced_quiz.html">Developer Advanced Quiz</a></li>
                                <li role="separator" class="divider"></li>
                                <li class="dropdown-header">Tutorials and practical's</li>
                                <li><a href="jr_user.html">User</a></li>
                                <li><a href="jr_developer_advanced.html">Developer Advanced</a></li>
                                <li role="separator" class="divider"></li>
                                <li class="dropdown-header">Help/info</li>
                                <li><a href="jr_glossary.html">Glossary List</a></li>
                                <li><a href="jr_links.html">Links</a></li>
                                <li><a href="jr_mqrg.html">My Quick Reference Guide</a></li>
                                <li><a href="jr_structures.html">JULES structures</a></li>
                                <li><a href="jr_rosecylc_setup.html">Rose/Cylc setup</a></li>
                                <li><a href="jr_vm_setup.html">JULES VM setup</a></li>
                                <li><a href="jr_jasmin_setup.html">JULES JASMIN setup</a></li>
                            </ul>
                        </li>
                    </ul>
                </div>
                <!--/.nav-collapse -->
            </div>
        </nav>
        <div class="container theme-showcase" role="main">
        <div class="jumbotron">
            <h1>Developer JULES-Rose Tutorial</h1>
            <p>This tutorial and practicals aim to cover the following topics:
            <ul>
                <li><a href="#bjrstem">Basics of JULES rose stem</a></li>
                <li><a href="#bcode">Basics of Coding -UMDP3, Reviewing</a></li>
                <li><a href="#bjrsuite">Running a basic JULES-Rose suite</a></li>
                <li><a href="#fjre">Further JULES Rose Edit</a></li>
                <li><a href="#fjrsuite">Further JULES-Rose suites - duration, domain</a></li>
                <li><a href="#fjrstem">Further JULES rose stem - namelists, modules</a></li>
                <li><a href="#ticks">More on Tickets - Populating</a></li>
                <li><a href="#hot">HoT branches and merging branch into it</a></li>
                <li><a href="#umj">UM-JULES</a></li>
                <li><a href="#md">Metadata</a></li>
                <li><a href="#upmac">Upgrade macros</a></li>
            </ul>
            </p>
        </div>
        <div class="well">
            <p>It is expected that you have:
            <ul>
            <li>Completed the <a href="http://metomi.github.io/rose/doc/rose.html">Rose User Guide</a>.</li>
            <li>Completed the <a href="jr_user.html">User Tutorial</a>.</li>
            <li>Completed the <a href="user_quiz.html">User Quiz</a>.</li>      
            </ul>
            </p>
            <p>
            OR have:
            <ul>
            <li>Experience running rose stem and JULES-Rose suites.</li>
            <li>Made basic changes to JULES-Rose suites.</li>
            <li>Experience with basic FCM commands.</li>
            </ul>
            </p>
        </div>

        <br/>

        <h2><a id="bjrstem">Basics of JULES rose stem</a></h2>
        <p>
        <ul>
            <div class="page-header">
                <h3>What is JULES rose stem?</h3>
            </div>
            <div class="well">
               <p>This is the test battery/suite of regression tests that code development changesets must be tested on.</p>
               <p>JULES needs to pass all of the tests for code to accepted on the trunk.</p>
               <p>Use the command <code>rose stem --group-all</code> to test all.</p>
               <p>Note for quick preliminary testing use <code>--group=loobos</code>.</code>
               <br/>
               <br/>
               <h4>Running rose stem</h4>
               <p>The following is an example/reminder of how to run rose stem.
                  Use it to help with the practicals.</p>
<pre>
# Checkout the code to run rose stem test for
mkdir -p ~/jules/vn4p8
cd ~/jules/vn4p8
fcm co fcm:jules.x_tr@vn4.8
cd ~/jules/vn4p8/trunk
rose stem --group=all --new --name=my_vn4p8tr_test
</pre>
            <h4>Questions</h4>
            <ol>
                <li>What are the three ways for looking at the job stderr?</li>
                <li>Where\What is the evidence for the Ticket Summary?</li>
                <li>What does KGO mean?</li>
                <li>When is it acceptable to have a failure in the KGO?</li>
            </ol>
            <br/>
            <div class="panel-group" id="accordion">
            <div class="panel panel-default">
                <div class="panel-heading">
                    <h4 class="panel-title">
                        <a data-toggle="collapse" data-parent="#accordion" href="#collapseOne">
                        <span class="glyphicon"></span>
                        Answers
                        </a>
                    </h4>
                </div>
                <div id="collapseOne" class="panel-collapse collapse">
                   <div class="panel-body">
                        <div class="row">
                            <pre>

<ol>
<li>What are the three ways for looking at the job stderr?</li>
<font color=green>In the gcylc GUI by right clicking on the task, select View, select job stderr.
In Rose Bush.
In the cylc-run/&lt;SUITE_NAME&gt;/log/job/1/&lt;TASK_NAME&gt;/NN directory.
</font>
<li>Where\What is the evidence for the Ticket Summary?</li>
<font color=green>The cylc-run/&lt;SUITE_NAME&gt;/trac.log file</font>
<li>What does KGO mean?</li>
<font color=green>Known Good Output</font>
<li>When is it acceptable to have a failure in the KGO?</li>
<font color=green>For example, when a bug has been identified and fixed, when the code has been improved.
These changes have to be justified usually with plots and approved by the code owner and Sci/tech Reviewer.</font>
</ol>
                            </pre>
                        </div>
                    </div>
                </div>
            </div>
            <div class="page-header">
                <h3>Running JULES rose stem and creating a branch and testing 
                    the new code in it</h3>
            </div>
            <div class="well">
            <p>Please refer to the <a href="https://code.metoffice.gov.uk/trac/jules/wiki/WorkingPractices">Working Practices for JULES development</a>.
            <br/>
            <p>Here we will make a basic change to the JULES code and test it
               with the rose stem test battery of tests.</p>
            <p>We know that the JULES code passes all the tests from running it
               earlier, we will make a branch for your change and see if the
               branch change does not create failures.</p>
           <h4>Creating a Branch</h4>
           <p>Creating a branch from the latest code release of JULES:</p>
           <p><code>cd ~jules</code>
           <p><code>fcm bc tutorial_bc_rosestem fcm:jules.x_tr@vn4.8</code>
           <br/>please insert the most recent version number.
           <br/><code>bc</code> - means <code>branch-create</code>
           <br/>"tutorial_bc_rosestem" will be the name of the branch.</p>
           <p>If you do not have keywords setup you will have to use the URL:
           <code>fcm bc tutorial_bc_rosestem https://code.metoffice.gov.uk/svn/jules/main/trunk@vn4.8</code></p>
           <p>This will bring up a text editor window for you to add your
              commit message about the branch.</p>
           <p>If you do not have text editor as default or wish to change the
              default you can use, for example:
              <code>export SVN_EDITOR=vim</code></p>
           <p>The editor window should look like this:
           <pre>

--Add your commit message ABOVE - do not alter this line or those below--
--FCM message (will be inserted automatically)--
Created /main/branches/dev/kerryday/vn4.8_tutorial_bc_rosestem from /main/trunk@5320.
--Change summary (not part of commit message)--
A    https://code.metoffice.gov.uk/svn/jules/main/branches/dev/kerryday/vn4.8_tutorial_bc_rosestem
</pre>
           Add a comment to the top of it and then close, save it and accept
           the change.
           </p>
           <p>This should return text like the following:</p>
           <pre>
<font color=blue>
[info] Source: https://code.metoffice.gov.uk/svn/jules/main/trunk@5320 (5320)
[info] vim: starting commit message editor...
Change summary:
--------------------------------------------------------------------------------
A    https://code.metoffice.gov.uk/svn/jules/main/branches/dev/kerryday/vn4.8_tutorial_bc_rosestem
--------------------------------------------------------------------------------
Commit message is as follows:
--------------------------------------------------------------------------------
Created /main/branches/dev/kerryday/vn4.8_tutorial_bc_rosestem from /main/trunk@5320.
--------------------------------------------------------------------------------
Create the branch?
Enter "y" or "n" (or just press &lt;return&gt; for "n") y
Committed revision ####.
[info] Created: https://code.metoffice.gov.uk/svn/jules/main/branches/dev/kerryday/vn4.8_tutorial_bc_rosestem
</font>
           </pre>
           <h4>Working on the Branch</h4>
           <p>There are two different ways of working on a branch, for code
              development I use the first and for suite development I use the
              second. Both have different merits and are given below.</p>
          <ol>
          <li>Check out a copy to a new directory.
             <br/>
             <p>For example: <code>fcm co fcm:jules.x_br/dev/USERNAME/BRANCH_NAME</code> and then move to that directory.</li>
          <li>Switch to the branch from within the directory of trunk@vn4.8.
             <br/>
             <p>For example: <code>fcm sw fcm:jules.x_br/dev/USERNAME/BRANCH_NAME</code>.</li>
          </ol>
          <p>Here we will use the first method (later we will use the second).</p>
          <br/>
          <pre>
cd ~jules/
fcm co fcm:jules.x_br/dev/USERNAME/vn4.8_tutorial_bc_rosestem
cd vn4.8_tutorial_bc_rosestem
</pre>
           <p>HELPFUL HINT: if you forget your branch name you can list them using:</p>
          <pre>
fcm bls
</pre>
          <p>Now check the information for the directory of the repository that
             you are presently in (very helpful when using switch) and the
             status</p>
<pre>
fcm info
<font color=blue>
Path: .
Working Copy Root Path: /USER/jules/vn4.8_tutorial_bc_rosestem
URL: https://code.metoffice.gov.uk/svn/jules/main/branches/dev/USERNAME/vn4.8_tutorial_bc_rosestem
Relative URL: ^/main/branches/dev/USERNAME/vn4.8_tutorial_bc_rosestem
Repository Root: https://code.metoffice.gov.uk/svn/jules
Repository UUID: ac5b6c67-d81e-4bef-bedc-f37a4dd2bd0a
Revision: 1222
Node Kind: directory
Schedule: normal
Last Changed Author: USERNAME
Last Changed Rev: 1234
Last Changed Date: 2030-12-01 09:21:40 +0000 (Mon, 01 Dec 2030)

</font>
fcm st

# returns nothing as there are no local/working copy changes in the directory.
</pre>
            <br/>
            <p>Make a basic change to the branch:</p>
            Note we are not keeping this change so it is not important
            what it is.
           <pre>
cd ~jules/vn4.8_tutorial_bc_rosestem/
fcm st

#this returns nothing
cd rose-stem/
# edit the rose-suite.conf, change HOUSEKEEPING to false, save and close the file
fcm st
<font color=blue>M       rose-suite.conf</font>
# we have decided that we did not want to change that, so lets revert it using
# fcm.
fcm revert rose-suite.conf
fcm st

# this returns nothing as we have reverted the uncommitted change that we made
# in our local/working directory.
          </pre>
            <p>The <code>fcm revert</code> command is very helpful if you want
               to revert, one, a few or all local changes.
               See <code>fcm revert --help</code> for more options.</p>
            <br/>
           <p>Now to make a change that we want to keep and test:</p>
           <pre>
cd ~jules/vn4.8_tutorial_bc_rosestem/
# move to the source/root directory of the JULES code
cd src/snow
# edit tridag.F90 ln 68 to be this:
  gamm(n) = c(n-1) / beta_2
# save and close the file
           </pre>
           <h4>Test the change</h4>
           <ol>
           <li>Run rose stem</li>
           <li>Look at the appropriate logs to provide evidence of success or
               failure</li>
           <li>What three methods can you use to find the answer for 2.?</li>
           <li>Which do you prefer and why?</li>
           </ol>
            <div class="panel-group" id="accordion">
            <div class="panel panel-default">
                <div class="panel-heading">
                    <h4 class="panel-title">
                        <a data-toggle="collapse" data-parent="#accordion" href="#collapseEleven">
                        <span class="glyphicon"></span>
                        Answers
                        </a>
                    </h4>
                </div>
                <div id="collapseEleven" class="panel-collapse collapse">
                   <div class="panel-body">
                        <div class="row">
                            <pre>
                            <font color=green>
Example failures and successes:
Fails - fcm_make_meto_linux_gfortran_omp
Fails - fcm_make_meto_linux_gfortran_debug
Fails - fcm_make_meto_xc40_cee_debug
Fails - fcm_make_meto_xc40_cee_omp
Fails - fcm_make_meto_linux_intel_debug_noomp_nompi
Fails - fcm_make_meto_linux_intel_noomp_mpi
Succeed - fcm_make_meto_xc40_cce_omp
Succeed - fcm_make_meto_xc40_cce_debug
                            </font>
                            </pre>
                            <img src="images/fail_rs.png" width="95%" id="fail1"/>
                            <p>job stderr states IMPLICIT NONE....for data object "BETA_2"</p>
                           <p>Which is the change we made.</p>
                           <p>Now revert the change using FCM</p>
                           <br/>
                          <p>The three methods are the gcylc GUI, Rose Bush and the cylc-run/ directory.</p>
                        </div>
                    </div>
                </div>
            </div>
            <br/>
            <p>You should have reverted that change if you are following this
               tutorial, make sure there are no local changes by using
               <code>fcm st</code> if there are changes please revert them.</p>
            <br/>
            <br/>
            <p><strong>In the developer tutorial we will add a new variable, 
               a new module etc.</strong></p>
               <p>We have created a branch, making a change then reverting it, testing
                  a change, finding the error and correcting it.</p>
              <br/>


            <br/>
            </div>
        </ul>

        <h2><a id="bcode">Basics of Coding -UMDP3, Reviewing</a></h2>
        <p>
        <ul>
            <div class="page-header">
                <h3>Why are their coding standards and reviewing?</h3>
            </div>
            <div class="well">
               <p>Coding standards provide quality assurance and help provide a consistent interface for development.</p>
               <p>Using coding standards and following the <a href="https://code.metoffice.gov.uk/trac/jules/wiki/WorkingPractices">working practices</a> and the <a href="https://code.metoffice.gov.uk/doc/um/vn10.6/papers/umdp_003.pdf">UMDP3</a> software standards aims to provide high quality code.</p>
                <p>It is known that not all of the current JULES code meets the standards and it is being constantly improved/developed to achieve this goal.</p>
                <p>No new code is allowed on the trunk unless it meets the coding standards.</p>
                <br/>
                <p>Reviewing is a very important process, not only must code meet the coding standards and pass the regression testing (rose stem) it must also go through a two stage review process.
                 <ul><li>Stage one is the Sci/Tech Review - code must be approved by the appropriate module owner(s) and reviewed Scientifically/Technically by a specialist in the area whom has not been involved in the development of the code.</li>
                 <li>Stage two is the Code Review - the code must meet the coding standards and be as efficient as possible.
                     At present the code reviewer is either Kerry Smout-Day (JULES System Manager) or a member of the UM Systems Team.</li></ul></p> 
            <br/>
            </div>
        </ul>


        <h2><a id="bjrsuite">Basics of JULES rose suite</a></h2>
        <p>
        <ul>
            <div class="page-header">
                <h3>How are JULES-Rose suites run?</h3>
            </div>
            <div class="well">
               <p>JULES-Rose suite can be run in two ways:</p>
               <ol>
               <li>At command line</li>
<pre>
# first checkout the suite if there is not already have a local copy
rosie checkout &lt;SUITE_ID&gt;
# change to the directory of the local copy
cd ~roses/&lt;SUITE_ID&gt;
rose suite-run --new #--name=&lt;DIFFERENT_NAME_IF_REQUIRED&gt;
</pre>
            <li>Via Rose Edit</li>
<pre>
# first checkout the suite if there is not already have a local copy
rosie checkout &lt;SUITE_ID&gt;
# change to the directory of the local copy
cd ~roses/&lt;SUITE_ID&gt;
# open rose edit for the suite
rose edit
# now press the play button to run the suite
</pre>
            <li>Via rosie go</li>
<pre>
rosie go
# select the suite to run and double click
# this opens rose edit
# now press the play button to run the suite
</pre>
            </ol>

            <p>
            <ol>
            <li>How can you reopen the gcylc GUI if accidently closed?</li>
            <li>What does the gcylc GUI going blank usually mean?</li>
            <li>What does a red square mean?</li>
            <li>What does a grey square mean?</li>
            <li>What does a green square mean?</li>
            <li>Where is the output of a task usually located?</li>
            </ol>
            </p>
            <div class="panel-group" id="accordion">
            <div class="panel panel-default">
                <div class="panel-heading">
                    <h4 class="panel-title">
                        <a data-toggle="collapse" data-parent="#accordion" href="#collapseTwo">
                        <span class="glyphicon"></span>
                        Answers
                        </a>
                    </h4>
                </div>
                <div id="collapseTwo" class="panel-collapse collapse">
                   <div class="panel-body">
                        <div class="row">
                            <pre>
<ol>
<li>How can you reopen the gcylc GUI if accidently closed?</li>
<font color=green>Two ways,
<code>cylc gscan</code> then double click on the name of the suite to open the gcylc GUI for,
or
<code>cylc sgc --name=&lt;SUITE_NAME&gt;</code></font>
<li>What does the gcylc GUI going blank usually mean?</li>
<font color=green>If there is "Stopped with succeeded" in the bottom left then it is finished</font>
<li>What does a red square mean?</li>
<font color=green>The task has failed</font>
<li>What does a grey square mean?</li>
<font color=green>The task has succeeded</font>
<li>What does a green square mean?</li>
<font color=green>The task is running</font>
<li>Where is the output of a task usually located?</li>
<font color=green>In the cylc-run/&lt;SUITE_NAME&gt;/work/1/&lt;TASK_NAME&gt;/output/ directory</font>
</ol>
                            </pre>
                        </div>
                    </div>
                </div>
            </div>

            <br/>
            </div>
            <div class="page-header">
                <h3>Who creates JULES-Rose suites?</h3>
            </div>
            <div class="well">
               <p>There are some example suites that can be found on the <a href="https://code.metoffice.gov.uk/trac/jules/wiki/JULESWithRose#StandardRosesuites-Pleaseaddyourownheretohelpothers">JULES MOSRS pages</a></p>
               <p>Some have been developed for the JULES-Rose tutorials:
              <ul><li> User Practical 5 and 6 - <a href="https://code.metoffice.gov.uk/trac/roses-u/browser/a/i/8/2/8">u-ai828</a> MetO Suite, <a href="https://code.metoffice.gov.uk/trac/roses-u/browser/a/i/8/2/9">u-ai829</a> VM Suite,  <a href="https://code.metoffice.gov.uk/trac/roses-u/browser/a/i/8/4/3">u-ai843</a> JASMIN Suite.
               </li>
               </ul>
               </p>
               <p>Anyone can create JULES-Rose suites, but it is often best to start from a suite that is similar to the one that is desired for a given experiment.</p>
               <p>Use ideas from others, it will save time.</p>
            <br/>
            </div>
        </ul>

        <h1><a id="Pracs">Practical's</a></h1>
        <p>
        <ul>
            <div class="page-header">
                <h2><a id="fjre">Practical 1 - Further JULES Rose Edit</a></h2>
            </div>
            <div class="well">
            <h3>Practical 1 will cover:</h3>
            <p>Make a change in Rose Edit and save it.</p>
            <p>Search for an item in a namelist.</p>
            <p>Make changes and undo the last one, save and commit changes.</p>
            <p>Open the suite.rc to make changes and Other files.</p>
            <p>View Ignored Variables and Latent Pages.</p>
            <p>Rose Bush via Rose Edit.</p>
            <p>Metadata and errors.</p>
            <br/>
            <p>A greater understanding and familiarity of Rose Edit will provide
               a section of techniques for making changes to JULES-Rose suites 
               allowing the user to choose their preferred method.</p>
            <h3>Make a change in Rose Edit and save it</h3>
            <p>Open Rose Edit for the suite u-ai828<p>
            <br/>
            <div class="panel-group" id="accordion">
            <div class="panel panel-default">
                <div class="panel-heading">
                    <h4 class="panel-title">
                        <a data-toggle="collapse" data-parent="#accordion" href="#collapseThree">
                        <span class="glyphicon"></span>
                        How To
                        </a>
                    </h4>
                </div>
                <div id="collapseThree" class="panel-collapse collapse">
                   <div class="panel-body">
                        <div class="row">
                            <pre>
# checkout the suite either using rosie go or command line

rosie go
# search for u-ai828
# double click on it to check it out, this checks it out locally and opens Rose Edit

# at command line
rosie checkout u-ai828
cd ~/roses/u-ai828
rose edit 
                            </pre>
                        </div>
                    </div>
                </div>
            </div>
            <br/>
            <p>Change the <code>WALLTIME</code> in the suite conf -&gt; Runtime configuration from 180 to 160.</p>
            <p>The <code>WALLTIME</code> should have changed colour from black
               to blue.
               There should be blue dots next to suite conf and Runtime 
               configuration.</p>
            <p>To save the change click on a different index, for example 
               fcm_make, then click <code>Check and save</code> the third 
               icon from the left of the Rose Edit GUI, which is "Abc" 
               underlined in a green wavy line.</p>
            <p>Confirmation that the change has been made can be seen by the
               blue dots disappearing and the writing changing back to black.</p>
            <br/>
            <h3>Search for an item in a namelist</h3>
                <p>In the icon panel of the Rose Edit GUI there is a blank box 
                   and an icon on binoculars next to it.
                   This is the search box and button.<p/>
                <p>Search <code>output</code>, press the search button until
                   all of the files with output are found.</p>
                <br/><img src="images/rose_edit_search.png" width="80%" id="res"/>
            <br/>
            <h3>Make changes and undo the last one, save and commit changes</h3>
            <p>Make some other changes:
              <ul>
              <li>Change can_rad_mod from 4 to 1.</li>
              <li>Change the location of the output from './output' to './tester/output'
              <p>What is the full path location that the new output directory would located?</p></li>
              <li>Change <code>JULES_OMP</code> to omp.</li>
              </ul>
              <p>Save the changes.</p>
              <p>How do you know that the changes are saved?</p>
            <br/>
            <div class="panel-group" id="accordion">
            <div class="panel panel-default">
                <div class="panel-heading">
                    <h4 class="panel-title">
                        <a data-toggle="collapse" data-parent="#accordion" href="#collapseFour">
                        <span class="glyphicon"></span>
                        How To and Answer
                        </a>
                    </h4>
                </div>
                <div id="collapseFour" class="panel-collapse collapse">
                   <div class="panel-body">
                        <div class="row">
                            <pre>
Search "can_rad_mod"
It is located in jules -&gt; namelist -&gt; jules_vegetation the second box down.
Search "output"
It is located in jules -&gt; namelist -&gt; jules_output the second box down, output_dir.
Search "JULES_OMP"
It is located in fcm -&gt; env the third box down.
<font color=green>The blue dots and text go.</font>
                            </pre>
                        </div>
                    </div>
                </div>
            </div>
            <br/>
            <p>Now undo the last change as we are not running with omp.
               This is done my using the <code>Undo</code> button.
               In the Rose Edit GUI this is the 6th icon button from the left 
               and is a yellow backward curving arrow.</p>
            <p>This and the green backward curving arrow directly to the right
               can be used to undo and redo changes in the order that they
               were made.</p>
            <p>Save the changes so there are only the three changes in total,
               WALLCLOCK, can_rad_mod and output_dir.</p>
            <p>Select the <code>Tools</code> tab, select <code>Launch Terminal</code>.
               This opens a terminal with at the suite directory path.
               Now check for local changes <code>fcm st</code>.</p>
<pre>
M       app/fcm_make/rose-app.conf
M       app/jules/rose-app.conf
M       rose-suite.conf
</pre>
             <p>To commit them to the repository <code>fcm ci</code> add a 
                comment, save, close and except.</p>
             <p>To revert all the changes before they are committed, close the 
                Rose Edit GUI, <code>fcm revert * -R</code>.</p>
             <p><strong>Remember you can only commit changes if you are the suite owner as defined in the rose-suite.info file.</strong></p>
            <br/>
            <h3>Open the suite.rc to make changes and Other files</h3>
                <p>Open Rose Edit again.</p>
                <p>Click on <code> suite conf</code>, the right hand panel will
                   display <code>Other files</code>, double click on the 
                   file <code>suite.rc</code>.</p>
                <br/>
                <p>Other files - </p>
                <p>There are other files, for example the Loobos data files 
                   are included in this suite.</p>
                <p>Find them located via clicking on <code>jules</code> the 
                   right hand panel displays <code>meta</code> and 
                    <code>Other files</code> at the bottom of it.</p>
                <br/><img src="images/rose_edit_other.png" width="85%" id="reo"/>

            <br/>
            <h3>View Ignored Variables/Pages and Latent Pages</h3>
                <p>Some variable and pages are hidden from users as the default.
                   These are known as <code>Ignored</code> Variable and Pages.</p>
                <p>We may want to see them in the Rose Edit GUI, they can be 
                   made viewable by: selecting the <code>View</code> tab and
                   then selecting <code>View Ignored Variables</code>,
                   <code>View Ignored Pages</code> and 
                   <code>View Latent Pages</code>.</p>
                 <p>With <code>View Ignored Variables</code> selected click on
                    the fcm_make -&gt; env section, it should now display three
                    greyed out variables, which have the <code>!!</code> in
                    front of them.
                    This is how you would see then in a text editor, they are 
                    not used which is why they were not displayed.</p>
                 <p>With <code>View Ignored Pages</code> selected click on
                    the jules -&gt; namelist, it should now display additional
                    namelists, which have the <code>!!</code> in
                    front of them.
                    There should be nine.
                    Click on one it should display:
                    <br/>
                    <img src="images/rose_edit_ignore.png" width="80%" id="rei"/></p>
                 <p>The <code>Latent Pages</code> are not often required, only
                    the poll one may be useful at a later date.
                    They show the possible other know of pages that could be 
                    populated.</p>
 
            <br/>
            <h3>Rose Bush via Rose Edit</h3>
                <p>If the suite has been run, which it was via Rose Edit in
                   the User Tutorial, or do it now.
                   It takes about 10 minutes, use the <code>Play</code> icon
                   button.
                   <p>Then Rose Bush, the web browser output page can be invoked.</p>
                      <p>Either - </p>
                      <p>Select the <code>Tools</code> tab and then select
                      <code>View Output</code></p>
                      <p>or</p>
                      <p>Select the <code>View Output</code> folder icon, the 
                      13th from the left.<p>
                      <p>Try one of the techniques.</p> 

            <br/>
            <h3>Metadata and errors</h3>
                <p>If a change is made which does not comply with the metadata
                   Rose Edit provides warnings.</p>
                <p>Note that selecting an invalid value for <code>MPI_NUM_TASKS</code>
                   provides a warning triangle and a red cog next to the 
                   offending variable, see the image below.</p>
                <br/> <img src="images/rose_edit_warning.png" width="80%" id="rew"/>
                <br/>
                <p>The important thing that we have to remember here is that
                   the Rose Edit can only be as good as the metadata that it is
                   provided with.
                   Therefore if we can improve the metadata for a suite then we
                   should.</p>
                <br/>
                <p>This suite works correctly at runtime, but does not use the
                   metadata in Rose Edit as it is not correctly specified for
                   Rose Edit.
                   To do this point it to the copy of the trunk, for example:
                   <code>/project/jules/vn4.8/trunk/</code> to the front of
                   both of the paths for fcm_make and jules metadata.</p>
               <p>Save and check the changes.</p>
               <p>Now the metadata is enabled we can see all of the information
                  on the variables.</p>
                <br/> <img src="images/rose_edit_meta.png" width="80%" id="rem"/>
                <br/> <img src="images/rose_edit_meta2.png" width="80%" id="rem2"/>
                <p>An example of different formats for presenting options with
                   metadata.<p/>
                <br/> <img src="images/rose_edit_meta4.png" width="80%" id="rem3"/>            

               <p>Select a variable and then right click, <code>Info</code>.
                <br/> <img src="images/rose_edit_meta3.png" width="80%" id="rem4"/>
               <p>From the image above you can see that the date has to have 
                  the correct format.</p>
                <p>Changing it to be incorrectly formatted provides a hover-over
                   error, as been in the image below.</p>
                <br/> <img src="images/rose_edit_meta5.png" width="80%" id="rem5"/>

            </div>
         </ul>

        <ul>
            <div class="page-header">
                <h2><a id="fjrsuite">Practical 2 - Further JULES-Rose suites - duration, domain</a></h2>
            </div>
            <div class="well">
            <h3>Practical 2 will cover:</h3>
            <p>Changing the JULES-Rose suite to run for a different duration.</p>
            <p>Changing the JULES-Rose suite to run for a different domain.</p>
            <br/>
           <h3>Changing the JULES-Rose suite to run for a different durations</h3>
           <br/>
           <h4><strong>For this section please use the JULES-Rose suite u-aj012</strong></h4>
           <br/>
           <p>For the VM use u-aj013 and for JASMIN use u-aj014.</p>
           <br/>
           <p>The suite uses GSWP2 data for one month.</p>
           <br/>
           <h4>Different time period - one off method</h4>
           <p>This is a simple change to the jules app, changing the 
              <code>app/jules/rose-app.conf</code> file:
<pre>
[namelist:jules_time]
main_run_end='1982-07-07 03:00:00'
main_run_start='1982-07-01 03:00:00'
</pre>
          </p>
          <br/>
           <h4>Different time period - flexible method</h4>
          <p>However, if this is something that you wish to change regularly 
             then it would be best to add variables to the <code>rose-suite.conf</code>
             file and pass them to the jules app as described below:</p>
           <p>In the <code>rose-suite.conf</code> file:
<pre>
MAIN_RUN_END='1982-07-07 03:00:00'
MAIN_RUN_START='1982-07-01 03:00:00' 
</pre>
           </p>
           <p>In the <code>suite.rc</code> file:
<pre>
     [[jules]]
         [[[environment]]]
             ...
             main_run_end   = {{ MAIN_RUN_END }}
             main_run_start = {{ MAIN_RUN_START }}
</pre> 
           </p>
           <p>In the <code>app/jules/rose-app.conf</code>:
<pre>
[env]
main_run_end=${main_run_end}
main_run_start=${main_run_start}

[namelist:jules_time]
main_run_end=${main_run_end}
main_run_start=${main_run_start}
</pre>
         </p>
           <br/>
           <p>As we are using a different time which is within the driving data
              date range we do not have to change the namelist:jules_drive.</p>
           <p>If we are to change the dates to a different month or year then 
              we must change:
<pre>
[namelist:jules_drive]
data_end='1982-07-31 23:59:59'
data_start='1982-07-01 03:00:00'
file='$GSWP2_INSTALL_DIR/drive/%vv/%vv198207.nc'
</pre>
             This may include sourcing more or different data, for example:
<pre>      
[namelist:jules_drive]
data_end='1986-03-31 23:59:59'
data_start='1986-03-01 03:00:00'
file='$GSWP2_INSTALL_DIR/drive/%vv/%vv198603.nc'
</pre>
               OR
<pre>      
[namelist:jules_drive]
data_end='1996-01-01 03:00:00'
data_start='1982-07-01 03:00:00'
file='drive_file.txt'
</pre>
          </p>
          <br/>
          <p>To add flexibility to the suite use the second option for the drive
             data as we have access to all of the files. </p>
           <br/>
           <h4>Yearly or Monthly</h4>
           <p>We are going to update our suite to run JULES for a year or a
              month at a time.
              This is because not all computers allow for tasks (jobs) to run
              for greater than a three hour wallclock limit. 
              Therefore some model runs, for example global data over 100's,
              may need to be split up into yearly/monthly JULES tasks so the
              computers will allow the model to not timeout.</p>
           <br/>
           <p>We are going to make changes very similar to the canradmod changes
              in the User course Practical 6 where we supplied a list of
              different canradmod settings to run jules for different optional
              configurations.
           </p>
           <p>This suite is slightly different in it design as the first time
              that JULES is run it will use driving data and from then onwards
              it will use the previous years data as its driving data. 
           </p>
           <br/>
           <p>This is first example is an example of yearly, but as it takes a
              while we not run it.
              The second example is monthly and we will implement monthly and 
              run it.</p>
           <br>
           <strong>Yearly Example only</strong>
           <p>Changes to the <code>rose-suite.conf</code> file:
<pre>
YEARS=["2011","2012","2013","2014","2015"]
WALLTIME=4320
</pre>
           </p>
           <p>Changes to the <code>suite.rc</code> file:
<pre>
graph = """
          fcm_make =&gt;\
          {% for year in YEARS %}
              jules_{{year}} =&gt;\
          {% endfor %}
          housekeep
        """

{% for year in YEARS %}
    [[jules_{{year}}]]
        inherit = SPICE
        {% if year == YEARS[0] %}
            script = "mkdir -p output ; rose task-run --app-key=jules --path= --path=share/fcm_make/build/bin"
        {% else %}
            script = "mkdir -p output ; rose task-run --app-key=jules -O dump --path= --path=share/fcm_make/build/bin"
          #Note - upper o not zero
        {% endif %}
        env-script = year_next=$(({{year}}+1))
        [[[environment]]]
        ...
...         year={{year}}
            year_next=${year_next}
{% endfor %}

    [[housekeep]]
        script = echo "Success!"
</pre>
           </p>
           <p>Changes to the <code>app/jules/</code> files and directory:
              Add an <code>opt/</code> directory.</p>

           <br/>
           <p>Add a file <code>rose-app-dump.conf</code> to the opt/ directory:
<pre>
[namelist:jules_initial]
dump_file=.true.
file='${CYLC_TASK_WORK_DIR}/output/gl6_notop_gswp2.dump.${year}0101.10800nc'
</pre>
           </p>
           <p>Changes to the app/jules/rose-app.conf file:
<pre>
[env]
year=${year}
year_next=${year_next}

[namelist:jules_time]
main_run_end='${year_next}-01-01 01:00:00'
main_run_start='${year}-01-01 01:00:00'

[namelist:jules_drive]
data_end='${year_next}-01-31 23:59:59'
data_start='${year}-01-01 03:00:00'
file='drive_file.txt
</pre>
           </p>
           <p>These are all of the changes that would need to be made.<p/>
           <br/>
           <strong>Monthly Example to do and run</strong>
           <p>Changes to the <code>rose-suite.conf</code> file:
<pre>
MONTHS=["07","08","09","10","11"]
YEAR="1985"
</pre>
           </p>
           <p>Changes to the <code>suite.rc</code> file:
<pre>
graph = """
          fcm_make =&gt;\
          {% for month in MONTHS %}
              jules_{{"%0.2d" % month|int}} =&gt;\
          {% endfor %}
          housekeep
        """

{% for month in MONTHS %}
    [[jules_{{"%0.2d" % month|int}}]]
        inherit = SPICE
        {% if month == MONTHS[0] %}
            script = "mkdir -p output ; rose task-run --app-key=jules --path= --path=share/fcm_make/build/bin"
        {% else %}
            script = "mkdir -p output ; rose task-run --app-key=jules -O dump --path= --path=share/fcm_make/build/bin"
                      #Note - upper o not zero
        {% endif %}
        env-script = """ month_next='{{ "%0.2d" % (month|int + 1)}}' """
        [[[environment]]]
        ...
...         month={{"%0.2d" % month|int}}
            month_next=${month_next}
            year={{ YEAR }}
{% endfor %}

    [[housekeep]]
        script = echo "Success!"
</pre>
           </p>
           <p>Changes to the <code>app/jules/</code> files and directory:
              Add an <code>opt/</code> directory.</p>

           <br/>
           <p>Add a file <code>rose-app-dump.conf</code> to the opt/ directory:
<pre>
[namelist:jules_initial]
dump_file=.true.
file='${CYLC_TASK_WORK_DIR}/output/gl6_notop_gswp2.dump.${year}${month}01.10800nc'
</pre>
           </p>
           <p>Changes to the app/jules/rose-app.conf file:
<pre>
[env]
year=${year}
month=${month}
month_next=${month_next}

[namelist:jules_time]
main_run_end='${year}-${month_next}-01 01:00:00'
main_run_start='${year}-${month}-01 01:00:00'

[namelist:jules_drive]
data_end='1996-01-01 03:00:00'
data_start='1982-07-01 03:00:00'
file='drive_file.txt'
nfiles=162
read_list=.true.
</pre>
           </p>
           <p>Now run the suite...
             ...look at the job.out for each task and check that the suite ran
             as you expected.</p>
           <br/>
           <p>A branch was created for this suite it is called "duration_ly_prac2", it has been fully tested and it can be used for comparison.</p>
           <br/>
            <br/>
            <h3>Changing the JULES-Rose suite to run for a different domain</h3>
            <p>In JULES there are two ways to change the domain:
            <ol>
            <li>Changing the namelist <code>jules_latlon</code> and uses a 
                single site.</li>
            <li>Changing the namelist  <code>jules_model_grid</code> and uses a
                gridbox domain.</li>
            </ol>
            </p>
            <p>The first requires all of the <code>Model grid</code> variables 
               in the <code>Grid configuration</code> to be <code>false</code>.
               Latitude and Longitude must be defined and the Input grid should
               be false and 1 x 1.
               u-ai828 (or u-ai829 for VM or u-ai843 for JASMIN, or u-ai844
               for remote JASMIN from your desktop) with the metadata specified
               has this setup.</p>
            <img src="images/rose_edit_dom1.png" width="80%" id="red1"/>
            <br/>
            <br/>
            <p>The second requires <code>Input grid</code> to be true and the
               other four variables defined.
               <code>Latitude and longitude</code> set to Latitude/Longitude
               including the ancil file location for the dataset.
               <code>Land fraction</code> needs the ancil file location and
               the name of the land fraction data.
               <code>Model grid</code> has the sub grid set to true and the
               boundaries to the lat and long of the domain.
               To see an example with the second type of setup see the 
               JULES-Rose suite u-ai509 with the metatdata specified as above.</p>
            <img src="images/rose_edit_dom2.png" width="80%" id="red2"/>
            <br/>
            <p>The suite u-ai828 requires Loobos data which is included within
               the suite.</p>
            <br/>
            <p>The suite u-ai509 (u-ai510 for VM or u-ai511 for JASMIN) require
               GWSP2 data which is very big but part of the VM install-jules-* 
               extra scripts so can be run on the VM
               if the data is available.
               Note this suite takes a while to run, about 25 mins.</p>
            <p>For a much faster running suite use u-aj012 (u-aj013 for VM or 
               u-aj014 for JASMIN + remoteJAMSIN), it is the same as
               u-ai509 but runs for only 1 month and not 1 year and therefore
               takes about 5 minutes to run.</p>
            <p>Change both suites:</p>
              <ul>
              <li>The first to run for a different site, Latitude 53.32 and 
                  Longitude 0.0.</li>
              <li>The second to run over the gridbox lat 53.5 55.5, long -1.0 1.0.</li>
              <li>The second again but to run globally (use u-ah270 for help),
                  note running this will take a very long time so you may want
                  to use u-ai511 for testing.</li>
              </ul></p>

             
            </div>
         </ul>
        <ul>
            <div class="page-header">
                <h2><a id="fjrstem">Practical 3 - Further JULES rose stem - namelists, modules</a></h2>
            </div>
            <div class="well">
            <h3>Practical 3 will cover:</h3>
            <p>Add a namelist to rose stem.</p>
            <p>Add a new module to rose stem.</p>
           <br/>
            <h4>Add a namelist to rose stem</h4>
            <ol>
            <p>A new namelist will always change the following files:
                <li>rose-meta/jules-standalone/HEAD/rose-meta.conf</li>
                <li>rose-meta/jules-standalone/versions.py</li>
            </p>
            <p>It will change a control file for the appropriate module in:
                <li>src/control/shared/???_mod.F90</li>
            </p>
            <p>It will also require changes to the relevant science schemes 
               i.e. in:
               <li>src/science/&lt;scheme&gt;/&lt;routine&gt;.F90</li>
            </p>
            </ol>
            <br/>
           <p>Lets add a namelist.</p>
           <p>This is an example of how to add a namelist which is taken from
              a namelist being added for JULES vn4.8 code release:</p>
           <ol>
               <li>Create a branch the JULES code from the trunk at vn4.8, 
                   include tutorial in its name</li>
               <li>Checkout the branch</li>
               <li>Add the following namelist to the rose-meta.conf
<pre>
[namelist:jules_surface=bio_hum_CN]
ns=namelist/Science settings/Surface options/Parameters
description=Bio and Hum Soil Carbon pools CN ratio
url=http://jules-lsm.github.io/vn4.6/namelists/jules_surface.nml.html#JULES_SURFACE::bio_hum_cn
type=real
range=0.01:
sort-key=m
</pre>
</li>
               <li>Edit the versions.py file to include your metadata and the 
                  original template, use <code>vn4.6_t000</code> and
<pre>
self.add_setting(config, ["namelist:jules_surface", "bio_hum_cn"], "10.0")
</pre>
</li>
               <li>To </code>src/control/shared/jules_surface_mod.F90</code>
                   add (~ln 275):
<pre>
! Parameters for soil respiration.
bio_hum_CN = 10.0
! Soil Bio and Hum CN ratio parameter
</pre>
                 add (~ln 290):
<pre>
! Parameters
bio_hum_CN
</pre>
                 add (~ln 465)
<pre>
WRITE(lineBuffer, *) '  bio_hum_CN = ', bio_hum_CN
CALL jules_print('jules_surface', lineBuffer)
</pre>           
                 (~ln 505) increase the number to 12
<pre>
INTEGER, PARAMETER :: n_real = 11 + 4
</pre>
                 add (~ln 530, 575, 610)
<pre>
REAL :: bio_hum_CN
my_nml % bio_hum_cn         = bio_hum_cn
bio_hum_CN         = my_nml % bio_hum_CN       
</pre>
</li>
               <li>rc/initialisation/standalone/initial_conditions/init_ic.inc
               add <code>bio_hum_cn</code> to the correct USE,
               add <code>ns_pool_gb, cs_pool_gb</code> to the correct USE
               add (~ln 470)
<pre>
!-------------------------------------------------------------------------------
! Initialise soil bio and hum pools from soil carbon
!-------------------------------------------------------------------------------
  IF (l_triffid ) THEN
    ns_pool_gb(:,3) = cs_pool_gb(:,3) / bio_hum_cn
    ns_pool_gb(:,4) = cs_pool_gb(:,4) / bio_hum_cn
  ENDIF 
</pre>
</li>
               <li>src/science/vegetation/soilcarb_jls.F90
               add <code>bio_hum_cn</code> to the USE including the module
               remove soil_cn   = 10.0
               update (~ln 120), soil_cn wih bio_hum_cn
<pre>
  cn(l,3) = bio_hum_cn           ! C:N ratio of BIO - Fixed
  cn(l,4) = bio_hum_cn           ! C:N ratio of HUM - Fixed
</pre>
              add (~ln 125)
<pre>
! N pool BIO+HUM are diagnostic from equivalent cSoil pool
  ns_pool_gb(l,3) = cs(l,3) / bio_hum_cn
  ns_pool_gb(l,4) = cs(l,4) / bio_hum_cn
</pre>
            update (~ln 220), soil_cn wih bio_hum_cn
<pre>
  IF (ns_pool_gb(l,3) &lt;  cs_min / bio_hum_cn) THEN
    neg_n(l) = neg_n(l) + ns_pool_gb(l,3) - cs_min / bio_hum_cn
  END IF
  IF (ns_pool_gb(l,4) &lt;  cs_min / bio_hum_cn) THEN
    neg_n(l) = neg_n(l) + ns_pool_gb(l,4) - cs_min / bio_hum_cn
</pre>
            update (~ln 230), soil_cn wih bio_hum_cn
<pre>
  ns_pool_gb(l,3) = MAX(ns_pool_gb(l,3),cs_min / bio_hum_cn)
  ns_pool_gb(l,4) = MAX(ns_pool_gb(l,4),cs_min / bio_hum_cn)
</pre>
</li>
           </ol>
           <p><a href="https://code.metoffice.gov.uk/trac/jules/changeset?reponame=&new=4852%40main%2Fbranches%2Fdev%2Fandywiltshire%2Fvn4.6_soil_cn&old=4285%40main%2Ftrunk">Diff from #309</a>
           <br/>
            <br/>
            <p>If you have added an Upgrade Macro you MUST also test it and apply the changes
               to the JULES code:
<pre>
rose app-upgrade -M /path/to/the/metadata/for/testing/ app/fcm_make &lt;version&gt; &amp;&amp; rose macro --fix -M /path/to/the/metadata/for/testing/
#or
./bin/upgrade_jules_test_apps vn#.#_t###

#here the &lt;version&gt; would be <code>HEAD</code> unless you change that metadata as well.
</pre>
</p>
            <br/>
           <p>Run the JULES rose stem tests to make sure that all of the tests
              pass.</p>
          <br/>
           <p>Other examples:
              <ul>
              <li><a href="https://code.metoffice.gov.uk/trac/jules/changeset?reponame=&new=6110%40main%2Fbranches%2Fdev%2Fadrianlock%2Fvn4.7_graup_in_jules&old=5320%40main%2Ftrunk">Diff from #414</a></li>
              <li><a href="https://code.metoffice.gov.uk/trac/jules/changeset?reponame=&new=5083%40main%2Fbranches%2Fdev%2Fjohnmedwards%2Fvn4.6_rgrain_rev&old=4285%40main%2Ftrunk">Diff from #298</a></li>
              </ul>
           </p>
           <br/>
            <h4>Add a new module to the JULES code</h4>
            <p>Why use modules and not subroutines with DEPENDS ON?</p>
            <ul>
            <li>
            <p>Modules are simple and make finding the piece of Fortran code
               that you are looking for easier to find.
               They also modulise the code therefore making files more user
               friendly and readable. 
               Further, adding, replacing and removing obsolete modules is
               easy.
            </li>
            </ul>
            </p>
            <p>Other reasons to use modules:
            <ol>
            <li>The compiler will check the number and types of arguments.</li>
            <li>the compiler can use memory in smarter ways.</li> 
            <li>Code is more portable.</li>
            <li>It takes seconds and can save hours of difficult debugging.</li>
            </ol>
            </p>
            <br/>
            <p>We will start by explaining the simplest form of how to use 
              modules and then we try adding our own and testing it.</p> 
           <br/>
            <ul>
            <li>
            <p>Simplest form:
            </li>
            </ul>
            </p>
            <p>
            Modules must start and end like this:
<pre>
MODULE my_mod
  CHARACTER(LEN=*), PARAMETER, PRIVATE :: ModuleName='MY_MOD'
  CONTAINS
  SUBROUTINE mycode(arg1, arg2)

  USE ...
  ...
  IMPLICIT NONE
  ....INTENT(IN)
  ....INTENT(INOUT)
  ....INTENT(OUT)
  ...
  INTEGER(KIND=jpim), PARAMETER :: zhook_in  = 0
  INTEGER(KIND=jpim), PARAMETER :: zhook_out = 1
  REAL(KIND=jprb)               :: zhook_handle
	
  CHARACTER(LEN=*), PARAMETER :: RoutineName='mycode'

  IF (lhook) CALL dr_hook(ModuleName//':'//RoutineName,zhook_in,zhook_handle)
  ...
  ...
  IF (lhook) CALL dr_hook(ModuleName//':'//RoutineName,zhook_out,zhook_handle)
  RETURN
  END SUBROUTINE mycode
END MODULE my_mod
</pre>
           They are used and called by:
<pre>
  ...
  USE my_mod, ONLY: mycode
  ...
  IMPLICIT NONE
  ...
  CALL mycode(arg1, arg2)
  ...
</pre>
           </p>
           <br/>
            <ul>
            <li>
            <p>Adding our own module:
            </li>
            </ul>
            </p>
            <p>
            Let apply this to a new module that we would like to add to the
            code.
           </p>
           <p>We are going to take the JULES vn4.8 release and move some code
               into a module.</p>
           <p>
           <ul>
           <li>Check out the JULES vn4.8 code release as vn4p8_tr</li>
           <li>Change to the created directory</li>
           <li><code>touch src/science/soil/n_leach_mod.F90</code></li>
           <li>Open the file src/science/soil/hydrol_jls.F90</li>
           <li>Line 63 add the USE statement for the new module "n_leach_mod" for the subroutine n_leach</li>
           <li>Lines 715-722 remove.</li>
           <li>Add a CALL for the subroutine and all the arguments it needs, 
               as shown above in the "Simplest form" example.</li> 
           <li>Lines 723-808 copy to the module called "n_leach_mod.F90"</li>
           <li>Add to the top and bottom of the n_leach_mod.F90 file as shown 
               above in the "Simplest form" example.</li>
           </ul>
           </p>

            <br/>
            <div class="panel-group" id="accordion">
            <div class="panel panel-default">
                <div class="panel-heading">
                    <h4 class="panel-title">
                        <a data-toggle="collapse" data-parent="#accordion" href="#collapseFive">
                        <span class="glyphicon"></span>
                        How To
                        </a>
                    </h4>
                </div>
                <div id="collapseFive" class="panel-collapse collapse">
                   <div class="panel-body">
                        <div class="row">
                            <p>
src/science/soil/hydrol_jls.F90
<pre>
USE n_leach_mod,              ONLY: n_leach

  CALL n_leach(npnts, nshyd, timestep, smcl, w_flux,                          &amp;
               sub_surf_roff, qbase_l, k_1m)
</pre>
src/science/soil/n_leach_mod.F90
<pre>
MODULE n_leach_mod
  CHARACTER(LEN=*), PARAMETER, PRIVATE :: ModuleName='N_LEACH_MOD'
  CONTAINS
  SUBROUTINE n_leach(npnts, nshyd, timestep, smcl, w_flux,                    &amp;
                     sub_surf_roff, qbase_l, k_1m)

USE parkind1, ONLY                : jprb, jpim
USE yomhook, ONLY                 : lhook, dr_hook
USE jules_surface_mod, ONLY       : l_layeredC
USE jules_hydrology_mod, ONLY     : l_top
USE jules_soil_mod, ONLY          : sm_levels, dzsoil
USE jules_surface_types_mod, ONLY : npft
USE prognostics, ONLY             : n_inorg_gb_lyrs, n_inorg_avail_pft
USE trif_vars_mod, ONLY           : n_leach_gb
USE jules_surface_mod, ONLY       : sorp

IMPLICIT NONE

INTEGER, INTENT(IN) ::                                                        &amp;
 npnts                                                                        &amp;
                     ! IN Number of gridpoints.
,nshyd                                                                        &amp;
                     ! IN Number of soil moisture levels.
,k_1m
                     !Layer index for top 1m



REAL, INTENT(IN) ::                                                           &amp;
 timestep                                                                     &amp;
                      ! Model timestep (s).
,w_flux(npnts,0:sm_levels)                                                    &amp;
                      ! Fluxes of water between layers  (kg/m2/s)
,qbase_l(npnts,sm_levels+1)                                                   &amp;
                      ! Base flow from each level (kg/m2/s).
,sub_surf_roff(npnts)                                                         &amp;
                      ! Sub-surface runoff (kg/m2/s).
,smcl(npnts,sm_levels)
                      ! Soil moisture content of each layer (kg/m2).

INTEGER ::                                                                    &amp;
  i,                                                                          &amp;
    !Counter for land points
  n
          !Counter for soil level

REAL ::                                                                       &amp;
 n_inorg_gb_old(npnts,sm_levels)                                              &amp;
          !Start value of inorganic nitrogen
,n_inorg_avail_old(npnts,npft,sm_levels)                                      &amp;
          !Start value of available inorganic nitrogen
,n_inorg_gb_tmp(npnts,nshyd)                                                  &amp;
,n_inorg_avail_tmp(npnts,npft,nshyd)
                      ! WORK temporary variables for inorganic Nitrogen



INTEGER(KIND=jpim), PARAMETER :: zhook_in  = 0
INTEGER(KIND=jpim), PARAMETER :: zhook_out = 1
REAL(KIND=jprb)               :: zhook_handle

CHARACTER(LEN=*), PARAMETER :: RoutineName='N_LEACH'


IF (lhook) CALL dr_hook(ModuleName//':'//RoutineName,zhook_in,zhook_handle)

!----------------------------------------------------------------------

  n_leach_gb(:) = 0.0
  DO i=1,npnts
    n_leach_gb(i) = 0.0
    IF (.NOT. l_layeredC) THEN
      IF (SUM(smcl(i,1:k_1m)) &gt; EPSILON(0.0)) THEN
        n_leach_gb(i) = sub_surf_roff(i) * (n_inorg_gb_lyrs(i,1) / sorp)      &amp;
                        / SUM(smcl(i,1:k_1m))  ! (top 1m)
      END IF
      n_leach_gb(i) = MIN(n_leach_gb(i),(n_inorg_gb_lyrs(i,1) / sorp)         &amp;
                      / timestep)
      !H20 flux                ! N concentration Kg [N]/kg [H20]
      n_inorg_gb_lyrs(i,1) = n_inorg_gb_lyrs(i,1) - n_leach_gb(i) * timestep
    ELSE !IF LAYERED C
      !Record old n_inorg, so we can calculate leaching.
      DO n=1,nshyd
        n_inorg_gb_tmp(i,n) = n_inorg_gb_lyrs(i,n)
        n_inorg_avail_tmp(i,:,n) = n_inorg_avail_pft(i,:,n)
      END DO

      ! Explicitly move n_inorg through the layers with w_flux.
      DO n=2,nshyd
        IF (w_flux(i,n-1) &gt;= 0.0 .AND. smcl(i,n-1) &gt; EPSILON(0.0)) THEN
          n_inorg_gb_lyrs(i,n) = n_inorg_gb_lyrs(i,n) + (timestep *           &amp;
                                 w_flux(i,n-1) * n_inorg_gb_tmp(i,n-1))       &amp;
                                 / (sorp * smcl(i,n-1))
          n_inorg_gb_lyrs(i,n-1) = n_inorg_gb_lyrs(i,n-1) - (timestep *       &amp;
                                   w_flux(i,n-1) * n_inorg_gb_tmp(i,n-1)) /   &amp;
                                   (sorp * smcl(i,n-1))
          n_inorg_avail_pft(i,:,n) = n_inorg_avail_pft(i,:,n) + (timestep *   &amp;
                                     w_flux(i,n-1) *                          &amp;
                                     n_inorg_avail_tmp(i,:,n-1)) /            &amp;
                                    (sorp * smcl(i,n-1))
          n_inorg_avail_pft(i,:,n-1) = n_inorg_avail_pft(i,:,n-1) - (timestep &amp;
                                       * w_flux(i,n-1) *                      &amp;
                                       n_inorg_avail_tmp(i,:,n-1)) /          &amp;
                                       (sorp * smcl(i,n-1))
        ELSE IF (w_flux(i,n-1) < 0.0 .AND. smcl(i,n) > EPSILON(0.0)) THEN
          n_inorg_gb_lyrs(i,n) = n_inorg_gb_lyrs(i,n) + (timestep *           &amp;
                                 w_flux(i,n-1) * n_inorg_gb_tmp(i,n)) /       &amp;
                                 (sorp * smcl(i,n))
          n_inorg_gb_lyrs(i,n-1) = n_inorg_gb_lyrs(i,n-1) - (timestep *       &amp;
                                   w_flux(i,n-1) * n_inorg_gb_tmp(i,n)) /     &amp;
                                   (sorp * smcl(i,n))
          n_inorg_avail_pft(i,:,n) = n_inorg_avail_pft(i,:,n) + (timestep *   &amp;
                                     w_flux(i,n-1) * n_inorg_avail_tmp(i,:,n))&amp;
                                     / (sorp * smcl(i,n))
          n_inorg_avail_pft(i,:,n-1) = n_inorg_avail_pft(i,:,n-1) - (timestep &amp;
                                       * w_flux(i,n-1) *                      &amp;
                                       n_inorg_avail_tmp(i,:,n)) /            &amp;
                                       (sorp * smcl(i,n))
        END IF
      END DO
      IF (w_flux(i,nshyd) &gt; 0.0 .AND. smcl(i,nshyd) &gt; EPSILON(0.0)) THEN
        n_inorg_gb_lyrs(i,nshyd) = n_inorg_gb_lyrs(i,nshyd) - (timestep *     &amp;
                                   w_flux(i,nshyd) *n_inorg_gb_tmp(i,nshyd))  &amp;
                                   / (sorp * smcl(i,nshyd))
        n_inorg_avail_pft(i,:,nshyd) = n_inorg_avail_pft(i,:,nshyd) -         &amp;
                                       (timestep * w_flux(i,nshyd) *          &amp;
                                       n_inorg_avail_tmp(i,:,nshyd)) /        &amp;
                                       (sorp * smcl(i,nshyd))
      END IF
      IF (w_flux(i,0) &lt; 0.0 .AND. smcl(i,1) &gt; EPSILON(0.0)) THEN
        n_inorg_gb_lyrs(i,1) = n_inorg_gb_lyrs(i,1) +  (timestep *            &amp;
                               w_flux(i,0) * n_inorg_gb_tmp(i,1)) /           &amp;
                               (sorp * smcl(i,1))
        n_inorg_avail_pft(i,:,1) = n_inorg_avail_pft(i,:,1) + (timestep *     &amp;
                                   w_flux(i,0) * n_inorg_avail_tmp(i,:,1)) /  &amp;
                                  (sorp * smcl(i,1))
      END IF
      IF (l_top) THEN ! LSH on: include leaching from lateral runoff.
        DO n=1,nshyd
          n_inorg_gb_lyrs(i,n) = n_inorg_gb_lyrs(i,n) - (timestep *           &amp;
                                 qbase_l(i,n) * n_inorg_gb_tmp(i,n)) /        &amp;
                                 (sorp * smcl(i,n))
          n_inorg_avail_pft(i,:,n) = n_inorg_avail_pft(i,:,n) - (timestep *   &amp;
                                     qbase_l(i,n) * n_inorg_avail_tmp(i,:,n)) /&amp;
                                     (sorp * smcl(i,n))
        END DO
      END IF ! LSH on.
      ! Calculate total leaching as difference in total inorganic
      ! nitrogen
      n_leach_gb(i) = (SUM(n_inorg_gb_tmp(i,:)) -                             &amp;
                       SUM(n_inorg_gb_lyrs(i,:))) / timestep
      n_leach_gb(i) = MAX(n_leach_gb(i),0.0)
    END IF !l_layeredC

  END DO

IF (lhook) CALL dr_hook(ModuleName//':'//RoutineName,zhook_out,zhook_handle)
RETURN
END SUBROUTINE n_leach
END MODULE n_leach_mod
                            </pre>
</p>
                        </div>
                    </div>
                </div>
            </div>
            <br/>
            <p>This example is based on JULES ticket<a href="">#394</a> which is               on the trunk and part of the JULES vn4.8 code release, but is
               different as soil tiling was implemented before this ticket.</p>
            <br/>
            <br/>
           <p>Run the JULES rose stem tests to make sure that all of the tests
              pass.</p>
           <br/>
           <p>What if tests failed?</p>
           <p>If we wanted this code on the JULES trunk then we would have to 
              make sure that none of the tests fail.
              Where could you look if tests failed for information on why they 
              had failed?
              We are not going to submit this code change for review as the
              was code it correctly implemented at vn4.8 with the soil tiling.
              This was just an example of how we could add a module.</p>
          <br/>

            </div>
         </ul>

        <ul>
            <div class="page-header">
                <h2><a id="ticks">Practical 4 - More on Tickets - Populating</a></h2>
            </div>
            <div class="well">
            <h3>Practical 4 will cover:</h3>
            <p>Why create a ticket?</p>
            <p>Creating a ticket.</p>
            <p>Filling in the empty ticket.</p>
            <p>Creating the Ticket Summary.</p>
            <p>Filling in the Ticket Summary.</p>
            <p>Adding the <code>trac.log output.</code></p>
            <p>The review process.</p>
            <br/>
            <br/>
            <h4>Why create a ticket?</h4>
            <p>There is something that needs improving in the JULES code.</p>
            <p>You have created a branch that you wish to go on the JULES code 
               trunk for everyone to benefit from.
               Firstly make sure that you have followed all of the <a href="https://code.metoffice.gov.uk/trac/jules/wiki/WorkingPractices">working practices</a>.
            <br/>
            <h4>Creating a ticket</h4>
            <p>Anyone can create a ticket to highlight an area of the JULES code
               that need development.</p>
            <p>Ideally you will also want and be able to resolve the ticket, or
               know someone that can.</p>
            <br/>
            <p>First login to the <a href="https://code.metoffice.gov.uk/trac/jules/">JULES MOSRS trac wiki</a>.
            <p>Either select the <code>New Ticket</code> tab at the top right
                of the page or use the link: 
             <a href="https://code.metoffice.gov.uk/trac/jules/newticket">Create a ticket</a></p>
            <br/>
            <img src="images/new_ticket.png" width="80%" id="red2"/>
            <br/>
            <h4>Filling in the empty ticket</h4>
            <p>Complete the <code>Summary</code> section. Chose the appropriate
            <code>Type</code> and only change the <code>Milestone</code> to the
            upcoming JULES code release if you think that you will complete it
            in time. <code>Owner</code> must be provided and is usually the 
            person that has opened the ticket. If someone is to be assigned
            please get their permission first. The <code>Priority</code>
            should be provided. Only the <code>CC</code> and <code>Keywords</code>
            are allowed to be left empty.</p>
            <p>The <code>Description</code> should be a clear and concise
               explanation of the problem and the proposed solution.
               There also needs to be a link to the branch and the Ticket
               Summary page.
               These can be created in preparation for the change even if they
               are not 100% ready, for example:
<pre>
[log:main/dev/user/branch_name branch_name]
[wiki:ticket/###/TicketSummary Ticket Summary]
</pre>
             The ### will be replaced by the ticket number once the ticket is 
             created.
</p>
            <p>Create the ticket using the <code>Create ticket</code> button.
            <br/>
            <h4>Creating the Ticket Summary</h4>
            <p>Clicking on the <code>Ticket Summary?</code> link will allow you
             to create the page.</p>
            <p>This opens a new page which displays:
<pre>
The page ticket/###/TicketSummary does not exist. You can create it here.

You could also create the same page higher in the hierarchy:

    TicketSummary?
"Create this page"  Using the template: "(blank page)"
</pre>
             Choose the option <code>Ticketsummary</code> not the (blank page),
             then select the button "Create this page".
             This will create the Ticket Summary page for you to fill in.</p>
            <br/>
            <h4>Filling in the Ticket Summary</h4>
            <p>You much be logged in to edit the Ticket Summary page.</p>
            <p>Go to the bottom of the page and select the button 
               <code>Edit this page</code>.
               Fill in all of the sections that you can at the time.</p>
            <br/>
            <h4>Adding the <code>trac.log</code>'s</h4>
            <p>After you have made your code change and are happy with it you
               have to run the JULES rose stem tests for your branch.</p>
            <p>More detail on rose stem have been discussed earlier in these
               tutorials.</p>
            <p>Once rose stem has completed then the <code>trac.log</code> can
               be copied to the Ticket Summary.</p>
           <p>The location of the trac.log: <code>~/cylc-run/&lt;BRANCH_NAME&gt;/trac.log</code>.</p>
            <p>Note that UM-JULES rose stem tests must be run with the group 
            <code>--group=jules,developer</code> if your site does not have this
               capability please email Jules-Support@metoffice.gov.uk to request
               assistance.</p>
            <br/>
            <h4>The review process</h4>
            <p>You must have code owner approval for your change before it is 
               reviewed.</p>
            <p>You will need to find a sci/tech reviewer and the JULES System
               Manger will code review your change.</p>
            <p>Please email people that you think may be willing to sci/tech 
               review your change to ask for a review before you assign it to
               them.</p>
            <p>Note anyone that has contributed to the branch cannot review the
               branch.</p>
           <p>Once the sci/tech review is done they should sign it off and 
              assign it to the JULES System Manager for the code review.
              They are responsible for checking the overall integrity of the
              change.
              Checking if the change will cause issues on the trunk, if the 
              testing was sufficient, and if the appropriate permissions and
              standards have been achieved.</p>
            <br/>
            </div>
         </ul>

        <ul>
            <div class="page-header">
                <h2><a id="hot">Practical 5 - HoT branches and merging branch into it</a></h2>
            </div>
            <div class="well">
            <h3>Practical 5 will cover:</h3>
            <p>Why do we need to create HoT branches.</p>
            <p>Creating a HoT branch.</p>
            <p>Merging in our original branch to the HoT branch.</p>
            <br/>
            <br/>
            <h4>Why do we need to create HoT branches</h4>
            <p>Branches should be created from the current JULES code release 
               version.
               A HoT branch is either requested or required if the present 
               branch may either cause conflicts with the <code>HEAD</code> of
               the trunk or they need to include the new code from the 
               <code>HEAD</code> to check that it does not break the latest
               <code>HEAD</code> of the trunk.</p>
            <br/>
            <h4>Creating a HoT branch</h4>
            <p>Below are the instructions for creating a HoT Branch, please 
follow them and create your own HoT.</p>
<pre>
# Create a branch from the JULES code repository at the head of the current trunk.
# Note there is no "@"
#  and there is not a version keyword or revision given after the "@".
fcm bc &gt;HOT_BRANCH_NAME&lt; fcm:jules.x_tr
# Add a comment to the commit message, include the ticket number if you have one. 
# Check out the HoT branch.
fcm co fcm:jules.x_br/dev/&gt;USERNAME&lt;/&gt;HOT_BRANCH_NAME&lt; 
</pre>
            <br/>
            <h4>Merging in our original branch to the HoT branch</h4>
            <p>Now we have a HoT we can merge our original branch into and then 
               check the difference using FCM.
               When we are happy with the code merge we can run all of our 
               JULES rose stem tests for the Ticket Summary for the 
               <code>trac.log</code> to be include in.</p>
            <p>Please follow the following instructions to include your
               original branch in the HoT branch tat you have just created.</p>
<pre>
# Move to the HoT branch directory.
cd &gt;HOT_BRANCH_NAME&lt;/
# Merge your branch to the HoT branch.
fcm merge fcm:jules.x_br/dev/&gt;USERNAME&lt;/&gt;BRANCH_NAME&lt;
# Check the merge
fcm diff -g
# Once happy commit the changes to the HoT branch.
fcm ci
# Add a suitable comment.
</pre>
            <br/>

            <br/>

            </div>
         </ul>


        <ul>
            <div class="page-header">
                <h2><a id="umj">Practical 6 - UM-JULES</a></h2>
            </div>
            <div class="well">
            <h3>Practical 6 will cover:</h3>
            <p>Why and When do we need to do a UM-JULES rose stem test?</p>
            <p>How do we run UM-JULES rose stem?</p>
            <p>What if there are failures?</p>
            <br/>
            <br/>
            <h4>Why and When do we need to do a UM-JULES rose stem test?</h4>
            <p>There are many reasons to why we may need to run a UM-JULES rose
               stem test.
               For example:
               <ul>
              <li>To check that there is no coding impact on the UM from the 
                  JULES code change when use in in the coupled UM-JULES model.</li>
              <li>To prove that the JULES code change does not change KGO when
                  run as the coupled UM-JULES model.</li>
              <li>When the JULES change also requires a UM change.</li>
            </ul>
            </p>
            <br/>
            <h4>How do we run UM-JULES rose stem?</h4>
            <p>For only testing a JULES change.</p>
            <ol>
            <li>Create a JULES ticket if it is not already created.</li>
            <li>Commit your JULES branch changes to the repository.</li>
            <li>Tested your JULES code changes and check the rose stem tests 
                all pass.</li>
            <li>Where do you find the evidence for the JULES rose stem tests for
                your branch?</li>
            <li>Where does the evidence need to be copied to?</li>
            <li>Checkout the UM trunk at the revision that your JULES change is
                for.</li>
            <li>Run the rose stem test.</li>
            <li>Where do you find the evidence for the UM rose stem tests for 
                the JULES branch?</li>
            <li>Where does the evidence need to be copied to?</li>
            </ol>
            <br/>
            <div class="panel-group" id="accordion">
            <div class="panel panel-default">
                <div class="panel-heading">
                    <h4 class="panel-title">
                        <a data-toggle="collapse" data-parent="#accordion" href="#collapseSix">
                        <span class="glyphicon"></span>
                        How To and Answers
                        </a>
                    </h4>
                </div>
                <div id="collapseSix" class="panel-collapse collapse">
                   <div class="panel-body">
                        <div class="row">
                            <pre>
<ol>
<li>See <a href="file:///net/home/h02/kerryday/jules-lsm.github.io.git/tutorial/bg_info/tutorial_julesrose/jr_user.html#P3">Tickets User</a> and <a href="file:///net/home/h02/kerryday/jules-lsm.github.io.git/tutorial/bg_info/tutorial_julesrose/jr_developer.html#ticks">Tickets Developer</a>.</li>
<li>fcm st
# check that all files are expected to have changes have and that any new
#are added and any removed are deleted.
fcm ci
# add a commit comment, save and close.
y
#to commit.</li>
<li>In the directory of the branch.
rose stem --group=all --new</li>
<li>~cylc-run/&lt;JULES_BRANCH_NAME&gt;/trac.log</li>
<li>JULES Ticket, Ticket Summary</li>
<li>
cd
mkdir -p um/
cd um
fcm co fcm:um.x_tr@10.5
# or if no fcm keywords set up
fcm co https://metoffice.code.gov.uk/svn/um/main/trunk@vn10.5
# for example if the change was a JULES vn4.8 branch
cd trunk</li>
<li>rose stem --group=jules --new --name=umtr_jls&lt;JULES_ticket_no&gt; --sourece=. --source=/full/path/to/jules/branch/to/be/tested</li>
<li>~cylc-run/umtr_jls&lt;JULES_ticket_no&gt;/trac.log</li>
<li>JULES Ticket, Ticket Summary</li>
</ol>
                            </pre>
                        </div>
                    </div>
                </div>
            </div>
            <br/>

            <p>For testing a JULES and UM combined change.</p>
            <ol>
            <li>Create a JULES ticket if it is not already created.</li>
            <li>Commit your JULES branch changes to the repository.</li>
            <li>Tested your JULES code changes and check the rose stem tests 
                all pass.</li>
            <li>Provide the evidence for you JULES branch rose stem tests in
                the JULES the Ticket Summary.</li>
            <li>Create a UM ticket and reference it in the JULES ticket,
                reference the JULES ticket in the UM ticket.</li>
            <li>Follow the <a href="https://code.metoffice.gov.uk/trac/um/wiki/working_practices">UM working practices</a>
            <li>Create a UM branch.</li>
            <li>Make changes.</li>
            <li>Run the rose stem tests on the UM-JULES coupled branches.</li>
            <li>Where do you find the evidence for the UM-JULES rose stem tests
                for the UM-JULES coupled branch?</li>
            <li>Where does the evidence need to be copied to?</li>
            </ol>
            <br/>
            <div class="panel-group" id="accordion">
            <div class="panel panel-default">
                <div class="panel-heading">
                    <h4 class="panel-title">
                        <a data-toggle="collapse" data-parent="#accordion" href="#collapseSeven">
                        <span class="glyphicon"></span>
                        How To and Answers
                        </a>
                    </h4>
                </div>
                <div id="collapseSeven" class="panel-collapse collapse">
                   <div class="panel-body">
                        <div class="row">
                            <pre>
<ol>
<li>See <a href="file:///net/home/h02/kerryday/jules-lsm.github.io.git/tutorial/bg_info/tutorial_julesrose/jr_user.html#P3">Tickets User</a> and <a href="file:///net/home/h02/kerryday/jules-lsm.github.io.git/tutorial/bg_info/tutorial_julesrose/jr_developer.html#ticks">Tickets Developer</a>.</li>
<li>fcm st
# check that all files are expected to have changes have and that any new
#are added and any removed are deleted.
fcm ci
# add a commit comment, save and close.
y
#to commit.</li>
<li>In the directory of the branch.
rose stem --group=all --new</li>
<li>Copy the ~cylc-run/&lt;JULES_BRANCH_NAME&gt;/trac.log to the JULES Ticket, Ticket Summary</li>
<li>See answer 1 but it is to be applied to the <a href="https://code.metoffice.gov.uk/trac/um">UM trac wiki pages</a> using the <a href="https://code.metoffice.gov.uk/trac/um/wiki/working_practices">UM working practices</a>.</li>
<li>As it says</li>
<li>
cd
mkdir -p um/
cd um
fcm bc &lt;UM_BRANCH_NAME&gt; fcm:um.x_tr@10.5
# or if no fcm keywords set up
fcm bc &lt;UM_BRANCH_NAME&gt; https://metoffice.code.gov.uk/svn/um/main/trunk@vn10.5
# for example if the change was a JULES vn4.8 branch
cd &lt;UM_BRANCH_NAME&gt;</li>
<li>Make your changes and commit them to the repository as you would for JULES.</li>
<li>rose stem --group=jules --new --source=. --source=/full/path/to/jules/branch/to/be/tested</li>
<li>~cylc-run/&lt;UM_BRANCH_NAME&gt;/trac.log</li>
<li>UM Ticket, Ticket Summary and the JULES Ticket, Ticket Summary</li>
</ol>
                            </pre>
                        </div>
                    </div>
                </div>
            </div>
            <br/>
            <p><strong>Note</strong> if it is a combined UM-JULES ticket then
               you need to get the tickets approved by the UM Systems team and 
               the JULES System Manager.
               Please email the UM System to ask to be assigned reviewers.</p>
            <br/>
            <h4>What if there are failures?</h4>
            <p>This as with a standard/standalone JULES change then the KGO can 
               only have failures for explained reasons and scientifically or
               technically approved reasons.
               <a href="file:///net/home/h02/kerryday/jules-lsm.github.io.git/tutorial/bg_info/tutorial_julesrose/jr_developer.html#bjrstem">When is it acceptable to have a failure in the KGO?</a></p>
            <br/>


            <br/>

            </div>
         </ul>

        <ul>
            <div class="page-header">
                <h2><a id="md">Practical 7 - Metadata</a></h2>
            </div>
            <div class="well">
            <h3>Practical 7 will cover:</h3>
            <p>What is the metadata for?</p>
            <p>How do I create metadata?</p>
            <p>How do I test metadata?</p>
            <br/>
            <br/>
            <h4>What is the metadata for?</h4>
            <p>Metadata is included as part of the JULES code to help users
               understand the intended use of variables, switches, parameters,
               etc in JULES.</p>
            <p>Metadata locations:
            <ul>
                 JULES code
                <li>benchmark/meta/rose-meta.conf</li>
                <li>rose-meta/jules-fcm-make/*/rose-meta.conf</li>
                <li>rose-meta/jules-standalone/*/rose-meta.conf</li>
                <li>rose-stem/meta/rose-meta.conf</li>
                <br/>
                JULES-Rose suites
                <li>meta/rose-meta.conf</li>
            </ul>
            </p> 
            <br/>
            <h4>How do I create metadata?</h4>
            <p>This depends on where the metadata is required.</p>
            <br/>
            <h5>JULES-Rose suites</h5>
            <p>u-ai828 is missing metadata for the rose-suite.conf file, which
               is called in by the suite.rc file.</p>
            <p>What two sets of metadata are missing from the the 
               <code>meta/rose-meta.conf</code> file?</p>
            <p>Checkout u-ai828, create a branch of u-ai828, switch to the
               branch, change the <code>meta/rose-meta.conf</code> file to
               include helpful information for the two missing variables,
               commit the changes to the branch and test using
               <code>rose edit</code>.
               Change the metadata so a negative values cannot be used, 
               <a href="http://metomi.github.io/rose/doc/rose-rug-metadata-tutorial.html">metadata help (Viewing the Info)</a> and the MPI_NUM_TASKS to help.
               Change the sort order. 
               Commit your changes to the branch and re-check it.</p>
            <br/>
            <div class="panel-group" id="accordion">
            <div class="panel panel-default">
                <div class="panel-heading">
                    <h4 class="panel-title">
                        <a data-toggle="collapse" data-parent="#accordion" href="#collapseEight">
                        <span class="glyphicon"></span>
                        How To Example
                        </a>
                    </h4>
                </div>
                <div id="collapseEight" class="panel-collapse collapse">
                   <div class="panel-body">
                        <div class="row">
                            <pre>
rosie checkout u-ai828
fcm bc metadata
fcm sw metadata
# edit meta/rose-meta.conf e.g.
[jinja2:suite.rc=JULES_PATH]
ns=Runtime configuration
compulsory=true
description=The path to the JULES code depending on the platform.
type=character
sort-key=d
# don't forget the other variable.
fcm ci
rose edit
# edit meta/rose-meta.conf sort-key and negative values not allowed.
fcm ci
rose edit
                            </pre>
                        </div>
                    </div>
                </div>
            </div>
            <br/>
            <br/>
            <h5>JULES code - rose-stem</h5>
            <p>This is very similar to the JULES-Rose suite example above, the
               metadata is in the <code>rose-stem/meta/rose-meta.conf</code> 
               file.
               Most users and developers will never have to edit this file.</p>
            <br/>
            <h5>JULES code - benchmark</h5>
            <p>This is very similar to the JULES-Rose suite example above, the
               metadata is in the <code>rose-stem/meta/rose-meta.conf</code>
               file.</p>
            <br/>
            <h5>JULES code - rose-meta</h5>
            <p>This is the file that most users that are not purely using
               JULES-Rose suites will want to edit.</p>
            <p>It is very infrequent that the
                <code>rose-meta/jules-fcm-make/versions.py</code>
               needs updating except for a release.
               It is not expected that a user/developer will need to edit this
               file.</p>
            <br/>
            <p>Therefore the corresponding <code>rose-meta/jules-fcm-make/HEAD/rose-meta.conf</code>
               file is not expected to be edited by a user/developer.</p>
            <br/>
            <p>In both the <code>rose-meta/jules-fcm-make/</code> and the 
               <code>rose-meta/jules-standalone/</code> directory there are 
               <code>vn#.#/rose-meta.conf</code> files these are updated at each
               release and or using the upgrade macro and are not to be 
               edited.</p>
            <br/>
            <p>The file <strong>for editing</strong> is only the most recent
               <code>rose-meta/jules-standalone/versions.py</code>
               file.</p>
           <p>An example of the file at the start of a release:</p>
<pre>
import rose.upgrade

from .version34_40 import *
from .version40_41 import *
from .version41_42 import *
from .version42_43 import *
from .version43_44 import *
from .version44_45 import *
from .version45_46 import *
from .version46_47 import *
from .version47_48 import *

class vn48_txxx(rose.upgrade.MacroUpgrade):

    """Upgrade macro from JULES by Author"""

    BEFORE_TAG = "vn4.8"
    AFTER_TAG = "vn4.8_txxx"

    def upgrade(self, config, meta_config=None):
        """Upgrade a JULES runtime app configuration."""

        # Add settings
        return config, self.reports

</pre>
            <p>During a release, after an edit:</p>
<pre>
import rose.upgrade

from .version34_40 import *
from .version40_41 import *
from .version41_42 import *
from .version42_43 import *
from .version43_44 import *
from .version44_45 import *
from .version45_46 import *
from .version46_47 import *

class vn47_t414(rose.upgrade.MacroUpgrade):

    """Upgrade macro from JULES by Adrian Lock"""

    BEFORE_TAG = "vn4.7"
    AFTER_TAG = "vn4.7_t414"

    def upgrade(self, config, meta_config=None):
        """Upgrade a JULES runtime app configuration."""

        # Add settings
        self.add_setting(config, ["namelist:jules_snow", "graupel_options"],
                         "0")
        return config, self.reports

class vn47_txxx(rose.upgrade.MacroUpgrade):

    """Upgrade macro from JULES by Author"""

    BEFORE_TAG = "vn4.7_txxx"
    AFTER_TAG = "vn4.7_txxx"

    def upgrade(self, config, meta_config=None):
        """Upgrade a JULES runtime app configuration."""

        # Add settings
        return config, self.reports
</pre>
            <br/>
            <p>Accompanying this <code>rose-meta/jules-standalone/versions.py</code>
              change is also a <code>rose-meta/jules-standalone/HEAD/rose-meta.conf</code>
              file change.</p>
            <p>For example, with the above change some sort-key values were
               updated and a new section added:</p>
<pre>
[namelist:jules_snow=graupel_options]
compulsory=true
description=Switch for treatment of graupel in the snow scheme
help=Always "Include graupel as snowfall" in standalone JULES because separate
    =snow and graupel driving data are not available.
    =If graupel is included in the UM surface snowfall diagnostic
    =then JULES can either include this graupel as snow in the surface scheme (option 0),
    =ignore this graupel completely, thereby breaking conservation
    =of water and energy in the coupled land-atmosphere model (option 1) or
    =treat graupel seperately (currently this only means allowing graupel to
    =fall straight through the canopy)
value-titles=Include graupel as snowfall,Ignore graupel in the surface snowfall,
            =Treat graupel seperately
values=0,1,2
url=http://jules-lsm.github.io/vn4.7/namelists/jules_snow.nml.html#JULES_SNOW::graupel_options
</pre>
            <br/>
            <p>Note in the jules-fcm-make/ directory there is only versions.py
               and no versions*_*.py files like in the jules-standalone.
               This is because there are relatively few changes to the 
               jules-fcm-make metadata unlike the jules-standalone metadata.
            <br/>
            <h4>How do I test metadata?</h4>
            <p><code>rose edit</code> checks the metadata, but if you do not
               have GUI's or prefer command line you can use 
               <code>rose metadata-check</code> in the metadata directory to 
               check the metadata.</p>
            <br/>
            <p>After changing the metadata in anyway or adding a new rose stem test (see 
               <a href="jr_developer_advanced.html">Developer Advanced Tutorial</a>)
<pre>
rose macro --fix -M /path/to/the/metadata/for/testing/
</pre>
            </p>
            <br/>
            <p>If you have added an Upgrade Macro you MUST also test it and apply the changes
               to the JULES code:
<pre>
rose app-upgrade -M /path/to/the/metadata/for/testing/ app/fcm_make &lt;version&gt; &amp;&amp; rose macro --fix -M /path/to/the/metadata/for/testing/
#or
./bin/upgrade_jules_test_apps vn#.#_t###
</pre>
</p>
            <br/>
            <br/>
            </div>
         </ul>

        <ul>
            <div class="page-header">
                <h2><a id="upmac">Practical 8 - Upgrade macros</a></h2>
            </div>
            <div class="well">
            <h3>Practical 8 will cover:</h3>
            <br/>
            <p>The versions.py in the above Practical leads us onto upgrade
                macros.</p>
            <br/>
            <p>How to run an upgrade macro.</p>
            <p>How to create an upgrade macro.</p>
            <p>create-app-rose.py</p>
            <br/>
            <br/>
            <h4>How to run an upgrade macro</h4>
            <p>Generally you will only need to run the following upgrade macros
               as documented below.
               For further information please see: <a href=""></a>
            </p>
<pre>
# Checkout the suite
rosie checkout &lt;suite_id&gt;
# OR copy the suite to get a new id
rosie copy &lt;suite_id&gt;
# move to the directory of the (new)suite id
cd ~/roses/&lt;(new)suite_id&gt;

# Apply upgrade macros
rose app-upgrade -C app/fcm_make &lt;version&gt; &amp;&amp; rose macro --fix -C app/fcm_make
rose app-upgrade -C app/jules &lt;version&gt;  &amp;&amp; rose macro --fix -C app/jules

# Commit the changes, noting the revision number from the commit
fcm ci
</pre>
            <p>Try upgrading u-aa799 by copying it and then upgrading it.</p>
            <br/>
            <h4>How to create an upgrade macro</h4>
            <p>Above in Practical 7 an upgrade macro was created in:
               <code>rose-meta/jules-standalone/versions.py</code>.
            <br/>
            <h4>create-app-rose.py</h4>
            <p>This is a utility to make namelists into a JULES-Rose suite.
               The app's can then be used in a rosie u repository suite for 
               science experiments.</p>
            <pre>
# create-app-rose vn_from vn_to namelist_path suite_name jules_code_path
#  for example:
create-rose-app vn4.4 vn4.8 /path/to/my/4.4/namelist/ my_4p4_conversion /path/to/my/jules/code/at/4.8/
</pre>
            <p>If you have a directory with old namelists files, please try the
               <code>create-app-rose</code> command.</p>
            <br/>
            <br/>
            <p>For more on Rose Upgrade and Upgrade Macros please see:
               <a href="http://metomi.github.io/rose/doc/rose.html">Rose Documentation</a>.</p>
             <p> <a href="http://metomi.github.io/rose/doc/rose-rug-advanced-tutorials-upgrade-usage.html">Upgrading</a>.</p>
             <p> <a href="http://metomi.github.io/rose/doc/rose-rug-advanced-tutorials-upgrade-dev.html">Upgrade Macro Development</a>.</p>
            <br/>

            </div>
         </ul>

            <h3>Congratulations you have completed the Developer Tutorial!</h3>

        <br/>
        <div class="container">
        <div class="well">
        Now lets do the Developer Quiz to highlight your learning.
        </div>
        <p><a class="btn btn-lg btn-success" href="developer_quiz.html" role="button">Developer Quiz</a></p>
        </div>
        <br/>
        <div class="container">
        </div>
        <hr/>
        <div class="container-fluid text-center">
        <div class="row">
        <div class="col-md-12">
        <address><small>
        &copy; British Crown Copyright 2006-17
        <a href="http://www.metoffice.gov.uk">Met Office</a>.<br />
        This document is released under the British <a href=
            "http://www.nationalarchives.gov.uk/doc/open-government-licence/" rel=
            "license">Open Government Licence</a>.<br />
        </small>
        </address>
        </div>
        </div>
        </div>
        <!-- Bootstrap core JavaScript
            ================================================== -->
        <!-- Placed at the end of the document so the pages load faster -->
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
        <script>window.jQuery || document.write('<script src="./js/vendor/jquery.min.js"><\/script>')</script>
        <script src="../etc/bootstrap/js/bootstrap.min.js"></script>
        <script src="./js/docs.min.js"></script>
        <script LANGUAGE="JavaScript">
            update = new Date(document.lastModified);
            theMonth = update.getMonth() + 1;
            theDate = update.getDate();
            theYear = update.getFullYear();
            theHour = update.getHours();
            theMin = update.getMinutes();
            theSec = update.getSeconds();
            document.write("<strong> Last Modified:</strong> " + theYear + "-" + theMonth + "-" + theDate + "T" + theHour + ":" + theMin + ":" + theSec + "Z");
                
        </script>
        </div>
    </body>
</html>

